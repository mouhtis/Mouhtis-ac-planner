<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mouhtis HVAC Suite</title>

<!-- Firebase compat (Î³Î¹Î± GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
async function generateAIStudy() {
  const area = $("#study_area").value;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value;

  const prompt = `
Î”ÏÏƒÎµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î³Î¹Î±:
â€¢ Î•Î¼Î²Î±Î´ÏŒÎ½: ${area} mÂ²
â€¢ Î§ÏÎ®ÏƒÎ·: ${usage}
â€¢ Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: ${ins}
`.trim();

  $("#aiStudyOutput").value = "â³ Î— AI Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î· Î¼ÎµÎ»Î­Ï„Î·...";

  try {
    const r = await fetch("https://odd-wind-8cb.mouhtis1.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await r.json();
    $("#aiStudyOutput").value = data.choices[0].message.content;
  } catch (err) {
    $("#aiStudyOutput").value = "âš ï¸ Î£Ï†Î¬Î»Î¼Î±: " + err;
  }
}


document.getElementById('study_ai_btn').onclick = generateAIStudy;

async function generateAIStudy(){
  const area=document.getElementById("study_area").value;
  const usage=document.getElementById("study_usage").value;
  const ins=document.getElementById("study_ins").value;
  const prompt = "Î”ÏÏƒÎµ Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ Î³Î¹Î± "+area+"mÂ², Ï‡ÏÎ®ÏƒÎ·: "+usage+", ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: "+ins;
  const out=document.getElementById("aiStudyOutput");
  out.value="â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±...";
  try{
    const r= await fetch("https://odd-wind-8cb.mouhtis1.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data=await r.json();
    out.value=data.choices[0].message.content;
  }catch(e){
    out.value="Î£Ï†Î¬Î»Î¼Î±:"+e;
  }
}

</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">
async function generateAIStudy() {
  const area = $("#study_area").value;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value;

  const prompt = `
Î”ÏÏƒÎµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î³Î¹Î±:
â€¢ Î•Î¼Î²Î±Î´ÏŒÎ½: ${area} mÂ²
â€¢ Î§ÏÎ®ÏƒÎ·: ${usage}
â€¢ Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: ${ins}
`.trim();

  $("#aiStudyOutput").value = "â³ Î— AI Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î· Î¼ÎµÎ»Î­Ï„Î·...";

  try {
    const r = await fetch("https://odd-wind-8cb.mouhtis1.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await r.json();
    $("#aiStudyOutput").value = data.choices[0].message.content;
  } catch (err) {
    $("#aiStudyOutput").value = "âš ï¸ Î£Ï†Î¬Î»Î¼Î±: " + err;
  }
}


document.getElementById('study_ai_btn').onclick = generateAIStudy;

async function generateAIStudy(){
  const area=document.getElementById("study_area").value;
  const usage=document.getElementById("study_usage").value;
  const ins=document.getElementById("study_ins").value;
  const prompt = "Î”ÏÏƒÎµ Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ Î³Î¹Î± "+area+"mÂ², Ï‡ÏÎ®ÏƒÎ·: "+usage+", ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: "+ins;
  const out=document.getElementById("aiStudyOutput");
  out.value="â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±...";
  try{
    const r= await fetch("https://odd-wind-8cb.mouhtis1.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data=await r.json();
    out.value=data.choices[0].message.content;
  }catch(e){
    out.value="Î£Ï†Î¬Î»Î¼Î±:"+e;
  }
}

</script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js">
async function generateAIStudy() {
  const area = $("#study_area").value;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value;

  const prompt = `
Î”ÏÏƒÎµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î³Î¹Î±:
â€¢ Î•Î¼Î²Î±Î´ÏŒÎ½: ${area} mÂ²
â€¢ Î§ÏÎ®ÏƒÎ·: ${usage}
â€¢ Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: ${ins}
`.trim();

  $("#aiStudyOutput").value = "â³ Î— AI Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î· Î¼ÎµÎ»Î­Ï„Î·...";

  try {
    const r = await fetch("https://odd-wind-8cb.mouhtis1.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await r.json();
    $("#aiStudyOutput").value = data.choices[0].message.content;
  } catch (err) {
    $("#aiStudyOutput").value = "âš ï¸ Î£Ï†Î¬Î»Î¼Î±: " + err;
  }
}


document.getElementById('study_ai_btn').onclick = generateAIStudy;

async function generateAIStudy(){
  const area=document.getElementById("study_area").value;
  const usage=document.getElementById("study_usage").value;
  const ins=document.getElementById("study_ins").value;
  const prompt = "Î”ÏÏƒÎµ Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ Î³Î¹Î± "+area+"mÂ², Ï‡ÏÎ®ÏƒÎ·: "+usage+", ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: "+ins;
  const out=document.getElementById("aiStudyOutput");
  out.value="â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±...";
  try{
    const r= await fetch("https://odd-wind-8cb.mouhtis1.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data=await r.json();
    out.value=data.choices[0].message.content;
  }catch(e){
    out.value="Î£Ï†Î¬Î»Î¼Î±:"+e;
  }
}

</script>

<!-- Chart.js Î³Î¹Î± Î³ÏÎ±Ï†Î®Î¼Î±Ï„Î± dashboard -->
<script src="https://cdn.jsdelivr.net/npm/chart.js">
async function generateAIStudy() {
  const area = $("#study_area").value;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value;

  const prompt = `
Î”ÏÏƒÎµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î³Î¹Î±:
â€¢ Î•Î¼Î²Î±Î´ÏŒÎ½: ${area} mÂ²
â€¢ Î§ÏÎ®ÏƒÎ·: ${usage}
â€¢ Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: ${ins}
`.trim();

  $("#aiStudyOutput").value = "â³ Î— AI Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î· Î¼ÎµÎ»Î­Ï„Î·...";

  try {
    const r = await fetch("https://odd-wind-8cb.mouhtis1.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await r.json();
    $("#aiStudyOutput").value = data.choices[0].message.content;
  } catch (err) {
    $("#aiStudyOutput").value = "âš ï¸ Î£Ï†Î¬Î»Î¼Î±: " + err;
  }
}


document.getElementById('study_ai_btn').onclick = generateAIStudy;

async function generateAIStudy(){
  const area=document.getElementById("study_area").value;
  const usage=document.getElementById("study_usage").value;
  const ins=document.getElementById("study_ins").value;
  const prompt = "Î”ÏÏƒÎµ Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ Î³Î¹Î± "+area+"mÂ², Ï‡ÏÎ®ÏƒÎ·: "+usage+", ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: "+ins;
  const out=document.getElementById("aiStudyOutput");
  out.value="â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±...";
  try{
    const r= await fetch("https://odd-wind-8cb.mouhtis1.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data=await r.json();
    out.value=data.choices[0].message.content;
  }catch(e){
    out.value="Î£Ï†Î¬Î»Î¼Î±:"+e;
  }
}

</script>

<style>
  :root{
    --bg:#f5f7fa;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --accent:#0b74de;
    --accent-dark:#095fb6;
    --accent-soft:#dbeafe;
    --sidebar-bg:#0d1b2a;
    --sidebar-bg2:#1b263b;
    --good:#16a34a;
    --bad:#dc2626;
  }

  *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
  }

  /* LOGIN */
  #loginScreen {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle at top,#e0f2fe,#f5f6fa);
    z-index: 9999;
  }
  #loginScreen h1 {
    font-size: 26px;
    margin-bottom: 10px;
    color: var(--accent);
  }
  #loginScreen .subtitle{
    font-size:13px;
    color:var(--muted);
    margin-bottom:18px;
  }
  #loginPass {
    padding: 10px 12px;
    width: 240px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    font-size: 15px;
    text-align:center;
  }
  #loginPass:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
  }
  #loginBtn {
    padding: 8px 18px;
    margin-top: 12px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    font-weight:600;
  }
  #loginBtn:hover { background: var(--accent-dark); }

  /* SIDEBAR */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 230px;
    height: 100vh;
    background: var(--sidebar-bg);
    color: white;
    padding-top: 20px;
  }
  .sidebar h2 {
    text-align: center;
    margin-bottom: 16px;
    font-weight: 600;
    font-size:18px;
  }
  .menu-btn {
    width: 90%;
    margin: 6px auto;
    padding: 10px 12px;
    background: var(--sidebar-bg2);
    color: white;
    border: none;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    display:flex;
    align-items:center;
    gap:8px;
    font-size:14px;
  }
  .menu-btn span.icon{width:20px;text-align:center;}
  .menu-btn:hover {
    background: #415a77;
  }
  .menu-btn.active{
    background:#415a77;
  }

  /* MAIN */
  .main {
    margin-left: 250px;
    padding: 20px 18px 40px;
    max-width:1100px;
  }
  h1 {
    margin: 0 0 6px 0;
    font-size:22px;
  }
  h2{margin:0 0 8px 0;font-size:18px;}
  h3{margin:0 0 6px 0;font-size:15px;}
  .subtitle{
    font-size:13px;
    color:var(--muted);
    margin-bottom:10px;
  }

  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 18px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    border:1px solid var(--border);
  }

  .btn {
    padding: 8px 16px;
    background: var(--accent);
    color: white;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    margin: 4px 4px 4px 0;
    font-weight: 600;
    font-size:13px;
  }
  .btn:hover { background: var(--accent-dark); }
  .btn.secondary{
    background:#fff;
    color:var(--accent);
    border:1px solid var(--accent-soft);
  }
  .btn.secondary:hover{
    background:var(--accent-soft);
  }
  .btn.small{font-size:12px;padding:5px 10px;}

  label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
    margin-bottom:2px;
  }
  input, select, textarea{
    width:100%;
    padding:7px 9px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:13px;
    outline:none;
  }
  textarea{resize:vertical;min-height:60px;}
  input:focus, select:focus, textarea:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
    background:#fff;
  }

  .search-box {
    padding: 9px 12px;
    width: 100%;
    max-width: 400px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    margin-bottom: 10px;
    font-size:13px;
  }

  .muted{font-size:12px;color:var(--muted);}

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th,td{
    padding:6px 4px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }
  th{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
  }

  .link{
    font-size:12px;
    color:var(--accent);
    cursor:pointer;
  }
  .link:hover{text-decoration:underline;}

  .pill{
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
  }
  .pill.green{background:#dcfce7;color:#166534;}
  .pill.red{background:#fee2e2;color:#b91c1c;}
  .pill.orange{background:#ffedd5;color:#9a3412;}

  /* DASHBOARD */
  .dashboard-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:12px;
  }
  .stat-card{
    background:var(--card);
    border-radius:12px;
    padding:12px 14px;
    border:1px solid var(--border);
    box-shadow:0 2px 6px rgba(15,23,42,0.04);
  }
  .stat-label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .stat-value{
    font-size:20px;
    font-weight:700;
  }
  .stat-sub{
    font-size:11px;
    color:var(--muted);
    margin-top:2px;
  }
  .stat-good{color:var(--good);}
  .stat-bad{color:var(--bad);}

  .charts-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:16px;
  }
  .chart-wrapper{
    background:var(--card);
    border-radius:12px;
    padding:10px 10px 4px;
    border:1px solid var(--border);
    box-shadow:0 2px 6px rgba(15,23,42,0.04);
  }
  .chart-wrapper h3{
    font-size:14px;
    margin-bottom:6px;
  }
  canvas{
    max-width:100%;
  }

  @media(max-width: 800px){
    .sidebar{
      position:relative;
      width:100%;
      height:auto;
    }
    .main{
      margin-left:0;
      padding:14px 12px 28px;
    }
  }
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <h1>Mouhtis HVAC Suite</h1>
  <div class="subtitle">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î¼Îµ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.</div>
  <input id="loginPass" type="password" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚" />
  <button id="loginBtn">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Menu</h2>
  <button class="menu-btn active" data-page="dashboard">
    <span class="icon">ğŸ“Š</span> Î£ÏÎ½Î¿ÏˆÎ·
  </button>
  <button class="menu-btn" data-page="customers">
    <span class="icon">ğŸ‘¤</span> Î ÎµÎ»Î¬Ï„ÎµÏ‚
  </button>
  <button class="menu-btn" data-page="tasks">
    <span class="icon">ğŸ› ï¸</span> Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚
  </button>
  <button class="menu-btn" data-page="project">
    <span class="icon">ğŸ“</span> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î­ÏÎ³Î¿Ï…
  </button>
  <button class="menu-btn" data-page="study">
    <span class="icon">ğŸ“</span> ÎœÎµÎ»Î­Ï„Î· ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï
  </button>
</div>

<!-- MAIN AREA -->
<div class="main" id="mainContent">
  <!-- Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Î±Ï€ÏŒ loadPage('dashboard') -->
</div>

<script>
/* ------------ LOGIN ------------ */
const loginBtn = document.getElementById("loginBtn");
loginBtn.onclick = () => {
  const pass = document.getElementById("loginPass").value.trim();
  if (pass === "fgb0911+") {
    document.getElementById("loginScreen").style.display = "none";
    loadPage("dashboard");
  } else {
    alert("Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚");
  }
};

/* ------------ FIREBASE (compat) ------------ */
const firebaseConfig = {
  apiKey: "AIzaSyAJlPDZktoQmDUIwQrCBsH_GLEhn5N6owE",
  authDomain: "mouhtis-suite.firebaseapp.com",
  projectId: "mouhtis-suite",
  storageBucket: "mouhtis-suite.firebasestorage.app",
  messagingSenderId: "1093547214312",
  appId: "1:1093547214312:web:83cc116f17b031f2ef105d",
  measurementId: "G-84HEW3XYX1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ------------ STATE ------------ */
let customers = [];
let tasks = [];
let projects = [];
let studies = [];
let profitChartInstance = null;
let taskTypeChartInstance = null;
let incomeChartInstance = null;

/* IDs Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± */
let editingCustomerId = null;
let editingTaskId = null;
let editingProjectId = null;
let editingStudyId = null;

/* ------------ HELPERS ------------ */
function $(sel){return document.querySelector(sel);}
function $all(sel){return Array.from(document.querySelectorAll(sel));}
function parseISODate(d){
  if(!d) return null;
  const parts = d.split("-");
  if(parts.length!==3) return null;
  return new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
}
function sameMonthYear(d,ref){
  return d && d.getMonth()===ref.getMonth() && d.getFullYear()===ref.getFullYear();
}
function sameYear(d,ref){
  return d && d.getFullYear()===ref.getFullYear();
}

/* ------------ CUSTOMERS CRUD ------------ */
async function loadCustomers(){
  try{
    const snap = await db.collection("customers").orderBy("createdAt","desc").get();
    customers = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderCustomerList();
  }catch(e){
    console.error("Error loading customers", e);
  }
}

function renderCustomerList(){
  const wrap = $("#customers_list");
  if(!wrap) return;
  const q = ($("#customers_search")?.value || "").toLowerCase();
  let arr = customers.slice();
  if(q){
    arr = arr.filter(c =>
      (c.name||"").toLowerCase().includes(q) ||
      (c.phone||"").toLowerCase().includes(q) ||
      (c.address||"").toLowerCase().includes(q) ||
      (c.area||"").toLowerCase().includes(q) ||
      (c.email||"").toLowerCase().includes(q)
    );
  }
  if(!arr.length){
    wrap.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.</div>';
    return;
  }
  let html = '<table><thead><tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</th><th>Î ÎµÏÎ¹Î¿Ï‡Î®</th><th>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(c=>{
    html += `<tr>
      <td>${c.name||""}</td>
      <td>${c.phone||""}</td>
      <td>${c.area||""}</td>
      <td>${c.address||""}</td>
      <td>
        <span class="link" data-c-edit="${c.id}">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</span>
        &nbsp;â€¢&nbsp;
        <span class="link" data-del="${c.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  $all('[data-del]').forEach(el=>{
    el.onclick = ()=> deleteCustomer(el.getAttribute('data-del'));
  });
  $all('[data-c-edit]').forEach(el=>{
    el.onclick = ()=> startEditCustomer(el.getAttribute('data-c-edit'));
  });
}

function startEditCustomer(id){
  const c = customers.find(c=>c.id===id);
  if(!c) return;
  editingCustomerId = id;
  $("#c_name").value = c.name || "";
  $("#c_phone").value = c.phone || "";
  $("#c_email").value = c.email || "";
  $("#c_address").value = c.address || "";
  $("#c_area").value = c.area || "";
  $("#c_notes").value = c.notes || "";
  $("#c_msg").textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î¬Ï„Î·. Î Î¬Ï„Î·ÏƒÎµ 'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚' Î³Î¹Î± Î±ÎºÏÏÏ‰ÏƒÎ·.";
  $("#c_save_btn").textContent = "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·";
}

async function saveCustomer(){
  const name = $("#c_name").value.trim();
  const phone = $("#c_phone").value.trim();
  const email = $("#c_email").value.trim();
  const address = $("#c_address").value.trim();
  const area = $("#c_area").value.trim();
  const notes = $("#c_notes").value.trim();
  const msgEl = $("#c_msg");
  if(!name){
    msgEl.textContent = "Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ ÏŒÎ½Î¿Î¼Î±.";
    return;
  }
  msgEl.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...";

  const data = { name, phone, email, address, area, notes };

  try{
    if(editingCustomerId){
      await db.collection("customers").doc(editingCustomerId).update(data);
      const idx = customers.findIndex(c=>c.id===editingCustomerId);
      if(idx>-1) customers[idx] = {...customers[idx], ...data};
      msgEl.textContent = "Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.";
    }else{
      const fullData = {
        ...data,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection("customers").add(fullData);
      customers.unshift({id:ref.id, ...fullData});
      msgEl.textContent = "Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.";
    }
    clearCustomerForm(false);
    renderCustomerList();
  }catch(e){
    console.error(e);
    msgEl.textContent = "Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
  }
}

function clearCustomerForm(clearMsg=true){
  $("#c_name").value="";
  $("#c_phone").value="";
  $("#c_email").value="";
  $("#c_address").value="";
  $("#c_area").value="";
  $("#c_notes").value="";
  editingCustomerId = null;
  const saveBtn = $("#c_save_btn");
  if(saveBtn) saveBtn.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·";
  if(clearMsg) $("#c_msg").textContent="";
}

async function deleteCustomer(id){
  if(!confirm("ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î¿ Ï€ÎµÎ»Î¬Ï„Î·Ï‚;")) return;
  try{
    await db.collection("customers").doc(id).delete();
    customers = customers.filter(c=>c.id!==id);
    tasks.forEach(t=>{ if(t.customerId===id) t.customerId=""; });
    projects.forEach(p=>{ if(p.customerId===id) p.customerId=""; });
    studies.forEach(s=>{ if(s.customerId===id) s.customerId=""; });
    renderCustomerList();
  }catch(e){
    console.error(e);
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.");
  }
}

/* ------------ TASKS CRUD (Î¼Îµ ÎºÏŒÏƒÏ„Î¿Ï‚ + Î¤Î¹Î¼Î®) ------------ */
async function loadTasks(){
  try{
    const snap = await db.collection("tasks").orderBy("createdAt","desc").get();
    tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderTaskList();
  }catch(e){
    console.error("Error loading tasks", e);
  }
}

function calcTaskTotalLocal(){
  const u = parseFloat($("#t_unitCost")?.value || "0") || 0;
  const m = parseFloat($("#t_materialsCost")?.value || "0") || 0;
  const h = parseFloat($("#t_laborHours")?.value || "0") || 0;
  const r = parseFloat($("#t_laborRate")?.value || "0") || 0;
  const labor = h * r;
  const total = u + m + labor;
  const el = $("#t_total_view");
  if(el) el.textContent = `Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: ${total.toFixed(2)} â‚¬ (Î•ÏÎ³Î±ÏƒÎ¯Î±: ${labor.toFixed(2)} â‚¬)`;
  return total;
}

function renderTaskList(){
  const wrap = $("#tasks_list");
  if(!wrap) return;
  const q = ($("#tasks_search")?.value || "").toLowerCase();
  const filter = ($("#tasks_filter")?.value || "all");
  let arr = tasks.slice();
  if(filter !== "all"){
    arr = arr.filter(t=>t.status===filter);
  }
  if(q){
    arr = arr.filter(t=>{
      const client = customers.find(c=>c.id===t.customerId);
      return (t.title||"").toLowerCase().includes(q) ||
             (t.notes||"").toLowerCase().includes(q) ||
             (client?.name||"").toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.</div>';
    return;
  }
  let html = '<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î¤ÏÏ€Î¿Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>ÎšÏŒÏƒÏ„Î¿Ï‚ (â‚¬)</th><th>Î¤Î¹Î¼Î® (â‚¬)</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(t=>{
    const client = customers.find(c=>c.id===t.customerId);
    const typeLabel =
      t.type==="installation" ? "Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·" :
      t.type==="fault" ? "Î’Î»Î¬Î²Î·" :
      t.type==="maintenance" ? "Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·" : "Î†Î»Î»Î¿";
    const pill =
      t.status==="done" ? '<span class="pill green">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</span>' :
      t.status==="inprogress" ? '<span class="pill orange">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</span>' :
      '<span class="pill red">Î‘Î½Î¿Î¹Ï‡Ï„Î®</span>';
    const costTotal = Number(t.costTotal || 0);
    const price = Number(t.price || 0);
    html += `<tr>
      <td>${t.title||""}</td>
      <td>${client?client.name:"â€”"}</td>
      <td>${typeLabel}</td>
      <td>${t.date||""}</td>
      <td>${costTotal.toFixed(2)}</td>
      <td>${price.toFixed(2)}</td>
      <td>${pill}</td>
      <td>
        <span class="link" data-task-edit="${t.id}">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</span>
        &nbsp;â€¢&nbsp;
        <span class="link" data-task-del="${t.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  $all('[data-task-del]').forEach(el=>{
    el.onclick = ()=> deleteTask(el.getAttribute('data-task-del'));
  });
  $all('[data-task-edit]').forEach(el=>{
    el.onclick = ()=> startEditTask(el.getAttribute('data-task-edit'));
  });
}

function startEditTask(id){
  const t = tasks.find(t=>t.id===id);
  if(!t) return;
  editingTaskId = id;
  $("#t_customer").value = t.customerId || "";
  $("#t_type").value = t.type || "installation";
  $("#t_title").value = t.title || "";
  $("#t_date").value = t.date || "";
  $("#t_status").value = t.status || "open";
  $("#t_notes").value = t.notes || "";
  $("#t_unitCost").value = t.unitCost ?? "";
  $("#t_materialsCost").value = t.materialsCost ?? "";
  $("#t_laborHours").value = t.laborHours ?? "";
  $("#t_laborRate").value = t.laborRate ?? "10";
  $("#t_price").value = t.price ?? "";
  calcTaskTotalLocal();
  $("#t_msg").textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚. Î Î¬Ï„Î·ÏƒÎµ 'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚' Î³Î¹Î± Î±ÎºÏÏÏ‰ÏƒÎ·.";
  $("#t_save_btn").textContent = "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·";
}

async function saveTask(){
  const customerId = $("#t_customer").value;
  const type = $("#t_type").value;
  const title = $("#t_title").value.trim();
  const date = $("#t_date").value;
  const status = $("#t_status").value;
  const notes = $("#t_notes").value.trim();
  const unitCost = parseFloat($("#t_unitCost").value || "0") || 0;
  const materialsCost = parseFloat($("#t_materialsCost").value || "0") || 0;
  const laborHours = parseFloat($("#t_laborHours").value || "0") || 0;
  const laborRate = parseFloat($("#t_laborRate").value || "0") || 0;
  const price = parseFloat($("#t_price").value || "0") || 0;
  const laborCost = laborHours * laborRate;
  const totalCost = unitCost + materialsCost + laborCost;

  const msgEl = $("#t_msg");
  if(!title){
    msgEl.textContent = "Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.";
    return;
  }
  msgEl.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...";

  const data = {
    customerId,
    type,
    title,
    date,
    status,
    notes,
    unitCost,
    materialsCost,
    laborHours,
    laborRate,
    laborCost,
    costTotal: totalCost,
    price
  };

  try{
    if(editingTaskId){
      await db.collection("tasks").doc(editingTaskId).update(data);
      const idx = tasks.findIndex(t=>t.id===editingTaskId);
      if(idx>-1) tasks[idx] = {...tasks[idx], ...data};
      msgEl.textContent = "Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.";
    }else{
      const fullData = {
        ...data,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection("tasks").add(fullData);
      tasks.unshift({id:ref.id, ...fullData});
      msgEl.textContent = "Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.";
    }
    clearTaskForm(false);
    renderTaskList();
  }catch(e){
    console.error(e);
    msgEl.textContent = "Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
  }
}

function clearTaskForm(clearMsg=true){
  $("#t_customer").value="";
  $("#t_type").value="installation";
  $("#t_title").value="";
  $("#t_date").value="";
  $("#t_status").value="open";
  $("#t_notes").value="";
  $("#t_unitCost").value="";
  $("#t_materialsCost").value="";
  $("#t_laborHours").value="";
  $("#t_laborRate").value="10";
  $("#t_price").value="";
  const el = $("#t_total_view");
  if(el) el.textContent = "Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: 0.00 â‚¬ (Î•ÏÎ³Î±ÏƒÎ¯Î±: 0.00 â‚¬)";
  editingTaskId = null;
  const btn = $("#t_save_btn");
  if(btn) btn.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·";
  if(clearMsg) $("#t_msg").textContent="";
}

async function deleteTask(id){
  if(!confirm("ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· ÎµÏÎ³Î±ÏƒÎ¯Î±;")) return;
  try{
    await db.collection("tasks").doc(id).delete();
    tasks = tasks.filter(t=>t.id!==id);
    renderTaskList();
  }catch(e){
    console.error(e);
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.");
  }
}

/* ------------ PROJECTS CRUD ------------ */
async function loadProjects(){
  try{
    const snap = await db.collection("projects").orderBy("createdAt","desc").get();
    projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderProjectList();
  }catch(e){
    console.error("Error loading projects", e);
  }
}

function calcProjectTotalLocal(){
  const u = parseFloat($("#proj_units")?.value || "0") || 0;
  const m = parseFloat($("#proj_materials")?.value || "0") || 0;
  const h = parseFloat($("#proj_helper_hours")?.value || "0") || 0;
  const r = parseFloat($("#proj_helper_rate")?.value || "0") || 0;
  const o = parseFloat($("#proj_other")?.value || "0") || 0;
  const helperCost = h*r;
  const total = u + m + helperCost + o;
  const el = $("#proj_total_view");
  if(el) el.textContent = `Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: ${total.toFixed(2)} â‚¬ (Î’Î¿Î·Î¸ÏŒÏ‚: ${helperCost.toFixed(2)} â‚¬)`;
  return total;
}

function renderProjectList(){
  const wrap = $("#projects_list");
  if(!wrap) return;
  const q = ($("#projects_search")?.value || "").toLowerCase();
  let arr = projects.slice();
  if(q){
    arr = arr.filter(p=>{
      const client = customers.find(c=>c.id===p.customerId);
      return (p.title||"").toLowerCase().includes(q) ||
             (p.location||"").toLowerCase().includes(q) ||
             (client?.name||"").toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.</div>';
    return;
  }
  let html = '<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th><th></th></tr></thead><tbody>';
  arr.forEach(p=>{
    const client = customers.find(c=>c.id===p.customerId);
    const total = Number(p.costTotal || 0);
    html += `<tr>
      <td>${p.title||""}</td>
      <td>${client?client.name:"â€”"}</td>
      <td>${p.date||""}</td>
      <td>${total.toFixed(2)}</td>
      <td>
        <span class="link" data-proj-edit="${p.id}">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</span>
        &nbsp;â€¢&nbsp;
        <span class="link" data-proj-del="${p.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  $all('[data-proj-del]').forEach(el=>{
    el.onclick = ()=> deleteProject(el.getAttribute('data-proj-del'));
  });
  $all('[data-proj-edit]').forEach(el=>{
    el.onclick = ()=> startEditProject(el.getAttribute('data-proj-edit'));
  });
}

function startEditProject(id){
  const p = projects.find(p=>p.id===id);
  if(!p) return;
  editingProjectId = id;
  $("#proj_customer").value = p.customerId || "";
  $("#proj_title").value = p.title || "";
  $("#proj_location").value = p.location || "";
  $("#proj_date").value = p.date || "";
  $("#proj_units").value = p.costUnits ?? "";
  $("#proj_materials").value = p.costMaterials ?? "";
  $("#proj_helper_hours").value = p.helperHours ?? "";
  $("#proj_helper_rate").value = p.helperRate ?? "5";
  $("#proj_other").value = p.costOther ?? "";
  $("#proj_notes").value = p.notes || "";
  calcProjectTotalLocal();
  $("#proj_msg").textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï…. Î Î¬Ï„Î·ÏƒÎµ 'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚' Î³Î¹Î± Î±ÎºÏÏÏ‰ÏƒÎ·.";
  $("#proj_save_btn").textContent = "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·";
}

async function saveProject(){
  const customerId = $("#proj_customer").value;
  const title = $("#proj_title").value.trim();
  const location = $("#proj_location").value.trim();
  const date = $("#proj_date").value;
  const units = parseFloat($("#proj_units").value || "0") || 0;
  const mats = parseFloat($("#proj_materials").value || "0") || 0;
  const h = parseFloat($("#proj_helper_hours").value || "0") || 0;
  const r = parseFloat($("#proj_helper_rate").value || "0") || 0;
  const other = parseFloat($("#proj_other").value || "0") || 0;
  const notes = $("#proj_notes").value.trim();
  const msgEl = $("#proj_msg");
  if(!title){
    msgEl.textContent = "Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î­ÏÎ³Î¿Ï….";
    return;
  }
  const helperCost = h*r;
  const total = units + mats + helperCost + other;
  msgEl.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...";

  const data = {
    customerId,
    title,
    location,
    date,
    costUnits: units,
    costMaterials: mats,
    helperHours: h,
    helperRate: r,
    costOther: other,
    costTotal: total,
    notes
  };

  try{
    if(editingProjectId){
      await db.collection("projects").doc(editingProjectId).update(data);
      const idx = projects.findIndex(p=>p.id===editingProjectId);
      if(idx>-1) projects[idx] = {...projects[idx], ...data};
      msgEl.textContent = "Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.";
    }else{
      const fullData = {
        ...data,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection("projects").add(fullData);
      projects.unshift({id:ref.id, ...fullData});
      msgEl.textContent = "Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.";
    }
    clearProjectForm(false);
    renderProjectList();
  }catch(e){
    console.error(e);
    msgEl.textContent = "Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
  }
}

function clearProjectForm(clearMsg=true){
  $("#proj_customer").value="";
  $("#proj_title").value="";
  $("#proj_location").value="";
  $("#proj_date").value="";
  $("#proj_units").value="";
  $("#proj_materials").value="";
  $("#proj_helper_hours").value="";
  $("#proj_helper_rate").value="5";
  $("#proj_other").value="";
  $("#proj_notes").value="";
  calcProjectTotalLocal();
  editingProjectId = null;
  const btn = $("#proj_save_btn");
  if(btn) btn.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·";
  if(clearMsg) $("#proj_msg").textContent="";
}

async function deleteProject(id){
  if(!confirm("ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Ï„Î¿ Î­ÏÎ³Î¿;")) return;
  try{
    await db.collection("projects").doc(id).delete();
    projects = projects.filter(p=>p.id!==id);
    renderProjectList();
  }catch(e){
    console.error(e);
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.");
  }
}

/* ------------ STUDIES CRUD ------------ */
async function loadStudies(){
  try{
    const snap = await db.collection("studies").orderBy("createdAt","desc").get();
    studies = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderStudyList();
  }catch(e){
    console.error("Error loading studies", e);
  }
}

function estimateBTU(area,usage,insulText){
  const m2 = area || 0;
  let per_m2 = 400;
  if(usage==="office") per_m2 = 450;
  if(usage==="shop")  per_m2 = 500;
  const txt = insulText.toLowerCase();
  if(txt.includes("ÎºÎ±Î»Î®")) per_m2 -= 40;
  if(txt.includes("ÎºÎ±ÎºÎ®") || txt.includes("Ï‡Ï‰ÏÎ¯Ï‚")) per_m2 += 60;
  const total = m2 * per_m2;
  return Math.round(total/1000)*1000;
}

function applyStudyCalc(){
  const area = parseFloat($("#study_area")?.value || "0") || 0;
  const usage = $("#study_usage")?.value || "home";
  const ins  = $("#study_ins").value || "";
  const totalBTU = estimateBTU(area,usage,ins);
  const txt = `Î•ÎºÏ„Î¯Î¼Î·ÏƒÎ· Ï†Î¿ÏÏ„Î¯Î¿Ï…: Ï€ÎµÏÎ¯Ï€Î¿Ï… ${totalBTU.toLocaleString()} BTU ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬.\nÎ ÏÏŒÏ„Î±ÏƒÎ·: Î´Î¹Î±Î¼Î¿Î¹ÏÎ±ÏƒÎ¼ÏŒÏ‚ ÏƒÎµ 2â€“3 Î¼Î¿Î½Î¬Î´ÎµÏ‚ inverter Î‘+++ ÏƒÏÎ¼Ï†Ï‰Î½Î± Î¼Îµ Ï„Î· Î´Î¹Î±ÏÏÏÎ¸Î¼Î¹ÏƒÎ·.`;
  const summaryEl = $("#study_summary");
  if(summaryEl){
    summaryEl.value = txt + "\n\n" + (summaryEl.value || "");
  }
}

function renderStudyList(){
  const wrap = $("#studies_list");
  if(!wrap) return;
  const q = ($("#studies_search")?.value || "").toLowerCase();
  let arr = studies.slice();
  if(q){
    arr = arr.filter(s=>{
      const client = customers.find(c=>c.id===s.customerId);
      const proj   = projects.find(p=>p.id===s.projectId);
      return (s.title||"").toLowerCase().includes(q) ||
             (s.summary||"").toLowerCase().includes(q) ||
             (client?.name||"").toLowerCase().includes(q) ||
             (proj?.title||"").toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.innerHTML = '<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÎµÎ»Î­Ï„ÎµÏ‚.</div>';
    return;
  }
  let html = '<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>ÎˆÏÎ³Î¿</th><th></th></tr></thead><tbody>';
  arr.forEach(s=>{
    const client = customers.find(c=>c.id===s.customerId);
    const proj   = projects.find(p=>p.id===s.projectId);
    html += `<tr>
      <td>${s.title||""}</td>
      <td>${client?client.name:"â€”"}</td>
      <td>${proj?proj.title:"â€”"}</td>
      <td>
        <span class="link" data-study-edit="${s.id}">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</span>
        &nbsp;â€¢&nbsp;
        <span class="link" data-study-del="${s.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  $all('[data-study-del]').forEach(el=>{
    el.onclick = ()=> deleteStudy(el.getAttribute('data-study-del'));
  });
  $all('[data-study-edit]').forEach(el=>{
    el.onclick = ()=> startEditStudy(el.getAttribute('data-study-edit'));
  });
}

function startEditStudy(id){
  const s = studies.find(s=>s.id===id);
  if(!s) return;
  editingStudyId = id;
  $("#study_title").value = s.title || "";
  $("#study_customer").value = s.customerId || "";
  $("#study_project").value = s.projectId || "";
  $("#study_area").value = s.area ?? "";
  $("#study_usage").value = s.usage || "home";
  $("#study_ins").value = s.insulation || "";
  $("#study_summary").value = s.summary || "";
  $("#study_msg").textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚. Î Î¬Ï„Î·ÏƒÎµ 'ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚' Î³Î¹Î± Î±ÎºÏÏÏ‰ÏƒÎ·.";
  $("#study_save_btn").textContent = "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·";
}

async function saveStudy(){
  const title = $("#study_title").value.trim();
  const customerId = $("#study_customer").value;
  const projectId  = $("#study_project").value;
  const area = parseFloat($("#study_area").value || "0") || 0;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value.trim();
  const summary = $("#study_summary").value.trim();
  const msgEl = $("#study_msg");
  if(!title){
    msgEl.textContent = "Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î¼ÎµÎ»Î­Ï„Î·Ï‚.";
    return;
  }
  msgEl.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·...";

  const data = {
    title,
    customerId,
    projectId,
    area,
    usage,
    insulation: ins,
    summary
  };

  try{
    if(editingStudyId){
      await db.collection("studies").doc(editingStudyId).update(data);
      const idx = studies.findIndex(s=>s.id===editingStudyId);
      if(idx>-1) studies[idx] = {...studies[idx], ...data};
      msgEl.textContent = "Î•Î½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ.";
    }else{
      const fullData = {
        ...data,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection("studies").add(fullData);
      studies.unshift({id:ref.id, ...fullData});
      msgEl.textContent = "Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.";
    }
    clearStudyForm(false);
    renderStudyList();
  }catch(e){
    console.error(e);
    msgEl.textContent = "Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.";
  }
}

function clearStudyForm(clearMsg=true){
  $("#study_title").value="";
  $("#study_customer").value="";
  $("#study_project").value="";
  $("#study_area").value="";
  $("#study_usage").value="home";
  $("#study_ins").value="";
  $("#study_summary").value="";
  editingStudyId = null;
  const btn = $("#study_save_btn");
  if(btn) btn.textContent = "Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·";
  if(clearMsg) $("#study_msg").textContent="";
}

async function deleteStudy(id){
  if(!confirm("ÎÎ± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ Î· Î¼ÎµÎ»Î­Ï„Î·;")) return;
  try{
    await db.collection("studies").doc(id).delete();
    studies = studies.filter(s=>s.id!==id);
    renderStudyList();
  }catch(e){
    console.error(e);
    alert("Î£Ï†Î¬Î»Î¼Î± ÏƒÏ„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.");
  }
}

/* ------------ SELECT HELPERS ------------ */
function fillCustomerSelect(selectId){
  const sel = $("#"+selectId);
  if(!sel) return;
  const prev = sel.value;
  sel.innerHTML = '<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>';
  customers.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c.id;
    opt.textContent=c.name;
    sel.appendChild(opt);
  });
  if(prev) sel.value=prev;
}
function fillProjectSelect(selectId){
  const sel = $("#"+selectId);
  if(!sel) return;
  const prev = sel.value;
  sel.innerHTML = '<option value="">â€” Î§Ï‰ÏÎ¯Ï‚ Î­ÏÎ³Î¿ â€”</option>';
  projects.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=p.title;
    sel.appendChild(opt);
  });
  if(prev) sel.value=prev;
}

/* ------------ DASHBOARD STATS ------------ */
function computeDashboardStats(){
  const now = new Date();
  const stats = {
    totalCustomers: customers.length,
    newCustomersMonth: 0,
    totalTasks: tasks.length,
    tasksMonth: 0,
    tasksDone: 0,
    tasksOpen: 0,
    tasksByType: {installation:0,fault:0,maintenance:0,other:0},
    totalProjects: projects.length,
    avgProjectCost: 0,
    maxProjectCost: 0,
    totalStudies: studies.length,
    avgStudyArea: 0,
    monthlyExpenses: 0,
    yearlyExpenses: 0
  };

  customers.forEach(c=>{
    if(c.createdAt && c.createdAt.toDate){
      const d = c.createdAt.toDate();
      if(sameMonthYear(d,now)) stats.newCustomersMonth++;
    }
  });

  tasks.forEach(t=>{
    const d = parseISODate(t.date);
    if(sameMonthYear(d,now)) stats.tasksMonth++;
    if(t.status==="done") stats.tasksDone++;
    if(t.status==="open") stats.tasksOpen++;
    if(stats.tasksByType[t.type]!=null) stats.tasksByType[t.type]++; else stats.tasksByType.other++;

    const c = Number(t.costTotal || 0);
    if(sameMonthYear(d,now)) stats.monthlyExpenses += c;
    if(sameYear(d,now)) stats.yearlyExpenses += c;
  });

  let totalCost = 0;
  let sumCost = 0;
  projects.forEach(p=>{
    const total = Number(p.costTotal||0);
    sumCost += total;
    if(total>stats.maxProjectCost) stats.maxProjectCost = total;
    totalCost++;
    const d = parseISODate(p.date);
    if(sameMonthYear(d,now)) stats.monthlyExpenses += total;
    if(sameYear(d,now)) stats.yearlyExpenses += total;
  });
  stats.avgProjectCost = totalCost? (sumCost/totalCost):0;

  let areaSum = 0, areaCount=0;
  studies.forEach(s=>{
    if(s.area){ areaSum+=Number(s.area); areaCount++; }
  });
  stats.avgStudyArea = areaCount? (areaSum/areaCount):0;

  return stats;
}

/* ------------ DASHBOARD RENDER ------------ */
function renderDashboard(){
  const main = $("#mainContent");
  const stats = computeDashboardStats();

  main.innerHTML = `
    <h1>Î Î¯Î½Î±ÎºÎ±Ï‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…</h1>
    <div class="subtitle">Î“ÎµÎ½Î¹ÎºÎ® ÎµÎ¹ÎºÏŒÎ½Î± Ï€ÎµÎ»Î±Ï„ÏÎ½, ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½, Î­ÏÎ³Ï‰Î½ ÎºÎ±Î¹ ÎºÏŒÏƒÏ„Î¿Ï…Ï‚.</div>

    <div class="dashboard-grid" style="margin-bottom:16px;">
      <div class="stat-card">
        <div class="stat-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚</div>
        <div class="stat-value">${stats.totalCustomers}</div>
        <div class="stat-sub">ÎÎ­Î¿Î¹ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±: <span class="stat-good">${stats.newCustomersMonth}</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</div>
        <div class="stat-value">${stats.totalTasks}</div>
        <div class="stat-sub">
          ÎœÎ®Î½Î±: ${stats.tasksMonth} â€¢ ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚: <span class="stat-good">${stats.tasksDone}</span> â€¢ Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚: <span class="stat-bad">${stats.tasksOpen}</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ÎˆÏÎ³Î±</div>
        <div class="stat-value">${stats.totalProjects}</div>
        <div class="stat-sub">
          Îœ.Î¿. ÎºÏŒÏƒÏ„Î¿Ï…Ï‚: ${stats.avgProjectCost.toFixed(0)}â‚¬ â€¢ ÎœÎ­Î³Î¹ÏƒÏ„Î¿: ${stats.maxProjectCost.toFixed(0)}â‚¬
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ÎœÎµÎ»Î­Ï„ÎµÏ‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï</div>
        <div class="stat-value">${stats.totalStudies}</div>
        <div class="stat-sub">Îœ.Î¿. ÎµÎ¼Î²Î±Î´Î¿Ï: ${stats.avgStudyArea.toFixed(1)} mÂ²</div>
      </div>
    </div>

    <div class="dashboard-grid" style="margin-bottom:16px;">
      <div class="stat-card">
        <div class="stat-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î­Î¾Î¿Î´Î± Î¼Î®Î½Î± (Î­ÏÎ³Î± + ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚)</div>
        <div class="stat-value">${stats.monthlyExpenses.toFixed(0)}â‚¬</div>
        <div class="stat-sub">Î¥Î»Î¹ÎºÎ¬, Î¼Î¿Î½Î¬Î´ÎµÏ‚, Î²Î¿Î·Î¸ÏŒÏ‚, ÎµÏÎ³Î±ÏƒÎ¯Î±, Î»Î¿Î¹Ï€Î¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î­Î¾Î¿Î´Î± Î­Ï„Î¿Ï…Ï‚ (Î­ÏÎ³Î± + ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚)</div>
        <div class="stat-value">${stats.yearlyExpenses.toFixed(0)}â‚¬</div>
        <div class="stat-sub">Î‘Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î® Ï„Î¿Ï… Î­Ï„Î¿Ï…Ï‚</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-wrapper">
        <h3>ÎˆÎ¾Î¿Î´Î± Î­ÏÎ³Ï‰Î½ Î±Î½Î¬ Î¼Î®Î½Î± (Î­Ï„Î¿Ï‚)</h3>
        <canvas id="profitChart" height="180"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>ÎšÎ±Ï„Î±Î½Î¿Î¼Î® ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½ Î±Î½Î¬ Ï„ÏÏ€Î¿</h3>
        <canvas id="taskTypeChart" height="180"></canvas>
      </div>
      <div class="chart-wrapper">
        <h3>ÎˆÏƒÎ¿Î´Î± / ÎˆÎ¾Î¿Î´Î± / ÎšÎ­ÏÎ´Î¿Ï‚ Î±Ï€ÏŒ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h3>
        <canvas id="incomeChart" height="220"></canvas>
        <div class="muted" style="font-size:11px;margin-top:4px;">
          Î¤ÏÎ­Ï‡Ï‰Î½ Î¼Î®Î½Î±Ï‚, Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Î¼Î®Î½Î±Ï‚ (30 Î·Î¼Î­ÏÎµÏ‚) ÎºÎ±Î¹ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚ (365 Î·Î¼Î­ÏÎµÏ‚).
        </div>
      </div>
    </div>
  `;

  drawProfitChart();
  drawTaskTypeChart();
  drawIncomeChart();
}

function drawProfitChart(){
  const ctx = document.getElementById("profitChart");
  if(!ctx) return;
  if(profitChartInstance) profitChartInstance.destroy();
  const now = new Date();
  const year = now.getFullYear();
  const labels = ["Î™Î±Î½","Î¦ÎµÎ²","ÎœÎ±Ï","Î‘Ï€Ï","ÎœÎ±Î¹","Î™Î¿Ï…Î½","Î™Î¿Ï…Î»","Î‘Ï…Î³","Î£ÎµÏ€","ÎŸÎºÏ„","ÎÎ¿Îµ","Î”ÎµÎº"];
  const data = new Array(12).fill(0);
  projects.forEach(p=>{
    const d = parseISODate(p.date);
    if(d && d.getFullYear()===year){
      const m = d.getMonth();
      data[m] += Number(p.costTotal||0);
    }
  });
  profitChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets:[{
        label:"ÎˆÎ¾Î¿Î´Î± Î­ÏÎ³Ï‰Î½ (â‚¬)",
        data,
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true}
      }
    }
  });
}

function drawTaskTypeChart(){
  const ctx = document.getElementById("taskTypeChart");
  if(!ctx) return;
  if(taskTypeChartInstance) taskTypeChartInstance.destroy();
  const counts = {installation:0,fault:0,maintenance:0,other:0};
  tasks.forEach(t=>{
    if(counts[t.type]!=null) counts[t.type]++; else counts.other++;
  });
  const labels = ["Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·","Î’Î»Î¬Î²Î·","Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·","Î†Î»Î»Î¿"];
  const data = [
    counts.installation,
    counts.fault,
    counts.maintenance,
    counts.other
  ];
  taskTypeChartInstance = new Chart(ctx,{
    type:"doughnut",
    data:{
      labels,
      datasets:[{data}]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{position:"bottom"}
      }
    }
  });
}

function drawIncomeChart(){
  const ctx = document.getElementById("incomeChart");
  if(!ctx) return;
  if(incomeChartInstance) incomeChartInstance.destroy();

  const now = new Date();
  const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);
  const start30 = new Date(now.getTime() - 29*24*60*60*1000);
  const start365 = new Date(now.getTime() - 364*24*60*60*1000);

  const buckets = {
    month: {exp:0, rev:0},
    d30: {exp:0, rev:0},
    y1: {exp:0, rev:0}
  };

  tasks.forEach(t=>{
    const d = parseISODate(t.date);
    if(!d) return;
    const cost = Number(t.costTotal || 0);
    const price = Number(t.price || 0);

    if(d >= startMonth){
      buckets.month.exp += cost;
      buckets.month.rev += price;
    }
    if(d >= start30){
      buckets.d30.exp += cost;
      buckets.d30.rev += price;
    }
    if(d >= start365){
      buckets.y1.exp += cost;
      buckets.y1.rev += price;
    }
  });

  const labels = ["Î¤ÏÎ­Ï‡Ï‰Î½ Î¼Î®Î½Î±Ï‚","Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Î¼Î®Î½Î±Ï‚","Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï‚"];
  const expenses = [
    buckets.month.exp,
    buckets.d30.exp,
    buckets.y1.exp
  ];
  const revenues = [
    buckets.month.rev,
    buckets.d30.rev,
    buckets.y1.rev
  ];
  const profits = revenues.map((r,i)=> r - expenses[i]);

  const profitColors = profits.map(p=>{
    if(p > 20) return "#16a34a";      // ÎºÎ­ÏÎ´Î¿Ï‚ â€“ Ï€ÏÎ¬ÏƒÎ¹Î½Î¿
    if(p < -20) return "#dc2626";     // Î¶Î·Î¼Î¹Î¬ â€“ ÎºÏŒÎºÎºÎ¹Î½Î¿
    return "#f97316";                 // ÏƒÏ‡ÎµÎ´ÏŒÎ½ Î¼Î·Î´Î­Î½ â€“ Ï€Î¿ÏÏ„Î¿ÎºÎ±Î»Î¯/ÎºÎ¯Ï„ÏÎ¹Î½Î¿
  });

  incomeChartInstance = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[
        { label:"ÎˆÎ¾Î¿Î´Î±", data:expenses },
        { label:"ÎˆÏƒÎ¿Î´Î±", data:revenues },
        { label:"ÎšÎ­ÏÎ´Î¿Ï‚", data:profits, backgroundColor:profitColors }
      ]
    },
    options:{
      responsive:true,
      scales:{
        y:{beginAtZero:true}
      }
    }
  });
}

/* ------------ PAGE RENDERING ------------ */
function loadPage(page){
  const main = document.getElementById("mainContent");
  let html = "";

  if(page==="dashboard"){
    Promise.all([loadCustomers(), loadTasks(), loadProjects(), loadStudies()]).then(()=>{
      renderDashboard();
    });
  }

  if(page==="customers"){
    html = `
      <h1>Î ÎµÎ»Î¬Ï„ÎµÏ‚</h1>
      <div class="subtitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ·, Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· & ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î±Ï„ÏÎ½.</div>

      <div class="card">
        <h3>ÎÎ­Î¿Ï‚ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î¬Ï„Î·</h3>
        <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
        <input id="c_name" placeholder="Ï€.Ï‡. Î“Î¹Î¬Î½Î½Î·Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚"/>

        <label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</label>
        <input id="c_phone" placeholder="69xxxxxxx"/>

        <label>Email</label>
        <input id="c_email" placeholder="example@mail.com"/>

        <label>Î ÎµÏÎ¹Î¿Ï‡Î®</label>
        <input id="c_area" placeholder="Ï€.Ï‡. Î¤Î¿ÏÎ¼Ï€Î±"/>

        <label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label>
        <input id="c_address" placeholder="ÎŸÎ´ÏŒÏ‚, Î±ÏÎ¹Î¸Î¼ÏŒÏ‚"/>

        <label>Î£Ï‡ÏŒÎ»Î¹Î±</label>
        <textarea id="c_notes" placeholder="Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï‡ÏÏÎ¿, Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·, Ï‰ÏÎ¬ÏÎ¹Î± ÎºÎ»Ï€."></textarea>

        <div style="margin-top:10px;">
          <button class="btn small" id="c_save_btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="c_clear_btn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
        </div>
        <div id="c_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="card">
        <h3>Î›Î¯ÏƒÏ„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½</h3>
        <input id="customers_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (ÏŒÎ½Î¿Î¼Î±, Ï„Î·Î», Ï€ÎµÏÎ¹Î¿Ï‡Î®, Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, email)..."/>
        <div id="customers_list" class="muted">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>
    `;
    main.innerHTML = html;

    document.getElementById("c_save_btn").onclick = saveCustomer;
    document.getElementById("c_clear_btn").onclick = ()=>clearCustomerForm(true);
    document.getElementById("customers_search").oninput = renderCustomerList;

    loadCustomers();
  }

  if(page==="tasks"){
    html = `
      <h1>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h1>
      <div class="subtitle">Î•Î³ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚, Î²Î»Î¬Î²ÎµÏ‚, ÏƒÏ…Î½Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚ Î¼Îµ ÎºÏŒÏƒÏ„Î¿Ï‚ & Ï„Î¹Î¼Î® Ï€ÏÎ¿Ï‚ Ï€ÎµÎ»Î¬Ï„Î·.</div>

      <div class="card">
        <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</h3>
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="t_customer"></select>

        <label>Î¤ÏÏ€Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
        <select id="t_type">
          <option value="installation">Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</option>
          <option value="fault">Î’Î»Î¬Î²Î·</option>
          <option value="maintenance">Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·</option>
          <option value="other">Î†Î»Î»Î¿</option>
        </select>

        <label>Î¤Î¯Ï„Î»Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
        <input id="t_title" placeholder="Ï€.Ï‡. Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 12.000 BTU"/>

        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input id="t_date" type="date"/>

        <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
        <select id="t_status">
          <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î®</option>
          <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
          <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</option>
        </select>

        <h3 style="margin-top:10px;">ÎšÏŒÏƒÏ„Î·</h3>
        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Î¼Î¿Î½Î¬Î´Î±Ï‚ / ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼Î¿Ï (â‚¬)</label>
        <input id="t_unitCost" type="number" step="0.01"/>

        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Ï…Î»Î¹ÎºÏÎ½ (â‚¬)</label>
        <input id="t_materialsCost" type="number" step="0.01"/>

        <label>ÎÏÎµÏ‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
        <input id="t_laborHours" type="number" step="0.5"/>

        <label>Î©ÏÎ¿Î¼Î¯ÏƒÎ¸Î¹Î¿ (â‚¬ / ÏÏÎ±)</label>
        <input id="t_laborRate" type="number" step="0.5" value="10"/>

        <div id="t_total_view" class="muted" style="margin-top:6px;">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: 0.00 â‚¬ (Î•ÏÎ³Î±ÏƒÎ¯Î±: 0.00 â‚¬)</div>

        <label>Î¤Î¹Î¼Î® Ï€ÏÎ¿Ï‚ Ï€ÎµÎ»Î¬Ï„Î· (â‚¬)</label>
        <input id="t_price" type="number" step="0.01"/>

        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="t_notes" placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚, Ï…Î»Î¹ÎºÎ¬, Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚."></textarea>

        <div style="margin-top:10px;">
          <button class="btn small" id="t_save_btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="t_clear_btn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
        </div>
        <div id="t_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="card">
        <h3>Î›Î¯ÏƒÏ„Î± ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½</h3>
        <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
        <select id="tasks_filter" style="max-width:200px;margin-bottom:6px;">
          <option value="all">ÎŒÎ»ÎµÏ‚</option>
          <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚</option>
          <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
          <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</option>
        </select>
        <input id="tasks_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (Ï„Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚)..."/>
        <div id="tasks_list" class="muted">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>
    `;
    main.innerHTML = html;

    loadCustomers().then(()=>fillCustomerSelect("t_customer"));
    loadTasks();

    $("#t_save_btn").onclick = saveTask;
    $("#t_clear_btn").onclick = ()=>clearTaskForm(true);
    $("#tasks_search").oninput = renderTaskList;
    $("#tasks_filter").onchange = renderTaskList;

    ["t_unitCost","t_materialsCost","t_laborHours","t_laborRate"].forEach(id=>{
      const el = $("#"+id);
      if(el) el.oninput = calcTaskTotalLocal;
    });
    calcTaskTotalLocal();
  }

  if(page==="project"){
    html = `
      <h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î­ÏÎ³Î¿Ï…</h1>
      <div class="subtitle">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÏŒÏƒÏ„Î¿Ï…Ï‚ Î±Î½Î¬ Î­ÏÎ³Î¿, Î¼Îµ Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.</div>

      <div class="card">
        <h3>ÎÎ­Î¿ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï…</h3>

        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="proj_customer"></select>

        <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î­ÏÎ³Î¿Ï…</label>
        <input id="proj_title" placeholder="Ï€.Ï‡. Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 3 ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½"/>

        <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
        <input id="proj_location" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î­ÏÎ³Î¿Ï…"/>

        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input id="proj_date" type="date"/>

        <h3 style="margin-top:10px;">ÎšÏŒÏƒÏ„Î·</h3>
        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ (â‚¬)</label>
        <input id="proj_units" type="number" step="0.01"/>

        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Ï…Î»Î¹ÎºÏÎ½ (â‚¬)</label>
        <input id="proj_materials" type="number" step="0.01"/>

        <label>ÎÏÎµÏ‚ Î²Î¿Î·Î¸Î¿Ï</label>
        <input id="proj_helper_hours" type="number" step="0.5"/>

        <label>Î©ÏÎ¿Î¼Î¯ÏƒÎ¸Î¹Î¿ Î²Î¿Î·Î¸Î¿Ï (â‚¬ / ÏÏÎ±)</label>
        <input id="proj_helper_rate" type="number" step="0.5" value="5"/>

        <label>Î†Î»Î»Î± ÎºÏŒÏƒÏ„Î· (â‚¬)</label>
        <input id="proj_other" type="number" step="0.01"/>

        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="proj_notes" placeholder="Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½, Î¼Î¿Î½Ï„Î­Î»Î± ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎºÎ»Ï€."></textarea>

        <div id="proj_total_view" class="muted" style="margin-top:6px;">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: 0.00 â‚¬ (Î’Î¿Î·Î¸ÏŒÏ‚: 0.00 â‚¬)</div>

        <div style="margin-top:10px%;">
          <button class="btn small" id="proj_save_btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="proj_clear_btn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
        </div>
        <div id="proj_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="card">
        <h3>Î›Î¯ÏƒÏ„Î± Î­ÏÎ³Ï‰Î½</h3>
        <input id="projects_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (Ï„Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±)..."/>
        <div id="projects_list" class="muted">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>
    `;
    main.innerHTML = html;

    loadCustomers().then(()=>fillCustomerSelect("proj_customer"));
    loadProjects();

    $("#proj_save_btn").onclick = saveProject;
    $("#proj_clear_btn").onclick = ()=>clearProjectForm(true);
    $("#projects_search").oninput = renderProjectList;

    ["proj_units","proj_materials","proj_helper_hours","proj_helper_rate","proj_other"].forEach(id=>{
      const el = $("#"+id);
      if(el) el.oninput = calcProjectTotalLocal;
    });
    calcProjectTotalLocal();
  }

  if(page==="study"){
    html = `
      <h1>ÎœÎµÎ»Î­Ï„Î· ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï</h1>
      <div class="subtitle">ÎœÎµÎ»Î­Ï„ÎµÏ‚ BTU & Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½, ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½ÎµÏ‚ Î¼Îµ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ ÎºÎ±Î¹ Î­ÏÎ³Î±.</div>

      <div class="card">
        <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚</h3>

        <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î¼ÎµÎ»Î­Ï„Î·Ï‚</label>
        <input id="study_title" placeholder="Ï€.Ï‡. ÎœÎµÎ»Î­Ï„Î· Î´Î¹Î±Î¼ÎµÏÎ¯ÏƒÎ¼Î±Ï„Î¿Ï‚ 85mÂ²"/>

        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="study_customer"></select>

        <label>Î£Ï‡ÎµÏ„Î¹ÎºÏŒ Î­ÏÎ³Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
        <select id="study_project"></select>

        <label>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎµÎ¼Î²Î±Î´ÏŒÎ½ (mÂ²)</label>
        <input id="study_area" type="number" step="1"/>

        <label>Î§ÏÎ®ÏƒÎ· Ï‡ÏÏÎ¿Ï…</label>
        <select id="study_usage">
          <option value="home">ÎšÎ±Ï„Î¿Î¹ÎºÎ¯Î±</option>
          <option value="office">Î“ÏÎ±Ï†ÎµÎ¯Î¿</option>
          <option value="shop">ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±</option>
        </select>

        <label>Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / Ï€ÏÎ¿ÏƒÎ±Î½Î±Ï„Î¿Î»Î¹ÏƒÎ¼ÏŒÏ‚</label>
        <textarea id="study_ins" placeholder="Ï€.Ï‡. Î”Ï…Ï„Î¹ÎºÏŒ ÏƒÎ±Î»ÏŒÎ½Î¹, Î¼Î­Ï„ÏÎ¹Î± Î¸ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·, Î¼ÎµÎ³Î¬Î»Î± Î±Î½Î¿Î¯Î³Î¼Î±Ï„Î±."></textarea>

        <label>Î£ÏÎ½Î¿ÏˆÎ· / BTU / Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Î¬Î´Ï‰Î½</label>
        <textarea id="aiStudyOutput" readonly style="width:100%;height:160px;"></textarea>

        

        <div style="margin-top:8px;">
          <button class="btn small" id="study_calc_btn">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ BTU</button>
<button class="btn small" id="study_ai_btn">AI Î ÏÏŒÏ„Î±ÏƒÎ· ÎœÎµÎ»Î­Ï„Î·Ï‚</button>
<button class="btn small" id="study_ai_btn">AI Î ÏÏŒÏ„Î±ÏƒÎ· ÎœÎµÎ»Î­Ï„Î·Ï‚</button>
          <button class="btn small" id="study_ai_btn">AI Î ÏÏŒÏ„Î±ÏƒÎ· ÎœÎµÎ»Î­Ï„Î·Ï‚</button>
        </div>

        <div style="margin-top:10px;">
          <button class="btn small" id="study_save_btn">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="study_clear_btn">ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
        </div>
        <div id="study_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="card">
        <h3>Î‘ÏÏ‡ÎµÎ¯Î¿ Î¼ÎµÎ»ÎµÏ„ÏÎ½</h3>
        <input id="studies_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (Ï„Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Î­ÏÎ³Î¿)..."/>
        <div id="studies_list" class="muted">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
      </div>
    `;
    main.innerHTML = html;

    Promise.all([loadCustomers(), loadProjects()]).then(()=>{
      fillCustomerSelect("study_customer");
      fillProjectSelect("study_project");
    });
    loadStudies();

    $("#studies_search").oninput = renderStudyList;
    $("#study_calc_btn").onclick = applyStudyCalc;
    $("#study_save_btn").onclick = saveStudy;
    $("#study_clear_btn").onclick = ()=>clearStudyForm(true);
  }

  $all(".menu-btn").forEach(btn=>{
    btn.classList.toggle("active", btn.getAttribute("data-page")===page);
  });
}

/* ------------ MENU BIND ------------ */
$all(".menu-btn").forEach(btn=>{
  btn.addEventListener("click", ()=> {
    const page = btn.getAttribute("data-page");
    loadPage(page);
  });
});

async function generateAIStudy() {
  const area = $("#study_area").value;
  const usage = $("#study_usage").value;
  const ins = $("#study_ins").value;

  const prompt = `
Î”ÏÏƒÎµ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï Î³Î¹Î±:
â€¢ Î•Î¼Î²Î±Î´ÏŒÎ½: ${area} mÂ²
â€¢ Î§ÏÎ®ÏƒÎ·: ${usage}
â€¢ Î˜ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· / ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: ${ins}
`.trim();

  $("#aiStudyOutput").value = "â³ Î— AI Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Ï„Î· Î¼ÎµÎ»Î­Ï„Î·...";

  try {
    const r = await fetch("https://odd-wind-8cb.mouhtis1.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    const data = await r.json();
    $("#aiStudyOutput").value = data.choices[0].message.content;
  } catch (err) {
    $("#aiStudyOutput").value = "âš ï¸ Î£Ï†Î¬Î»Î¼Î±: " + err;
  }
}


document.getElementById('study_ai_btn').onclick = generateAIStudy;

async function generateAIStudy(){
  const area=document.getElementById("study_area").value;
  const usage=document.getElementById("study_usage").value;
  const ins=document.getElementById("study_ins").value;
  const prompt = "Î”ÏÏƒÎµ Ï€ÏÏŒÏ„Î±ÏƒÎ· Î¼ÎµÎ»Î­Ï„Î·Ï‚ Î³Î¹Î± "+area+"mÂ², Ï‡ÏÎ®ÏƒÎ·: "+usage+", ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±: "+ins;
  const out=document.getElementById("aiStudyOutput");
  out.value="â³ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±...";
  try{
    const r= await fetch("https://odd-wind-8cb.mouhtis1.workers.dev",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({prompt})
    });
    const data=await r.json();
    out.value=data.choices[0].message.content;
  }catch(e){
    out.value="Î£Ï†Î¬Î»Î¼Î±:"+e;
  }
}

</script>

</body>
</html>
