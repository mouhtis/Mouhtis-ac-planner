<!doctype html>
<html lang="el">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mouhtis AC Planner — Full</title>

<!-- CDN libraries for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{--accent:#1e88e5;--muted:#666}
  body{font-family:Arial,Helvetica,sans-serif;margin:12px;background:#fafafa;color:#222}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  h1{font-size:20px;margin:0}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
  .controls input[type=file]{display:inline-block}
  button,input,select{padding:8px;border-radius:6px;border:1px solid #ddd;background:white}
  button{cursor:pointer}
  #canvasWrap{border:1px solid #ccc;background:white;display:block;max-width:100%;overflow:auto}
  canvas{display:block;max-width:100%;height:auto}
  .panel{display:grid;grid-template-columns:1fr 360px;gap:12px}
  .sidebar{background:#fff;padding:10px;border:1px solid #eee;border-radius:6px;max-height:78vh;overflow:auto}
  .rooms-table{width:100%;border-collapse:collapse}
  .rooms-table th,.rooms-table td{border:1px solid #eee;padding:6px;font-size:13px}
  .dot{width:14px;height:14px;border-radius:50%;background:#000;position:absolute;transform:translate(-50%,-50%);pointer-events:none}
  footer{margin-top:12px;font-size:13px;color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  @media(max-width:900px){ .panel{grid-template-columns:1fr} .sidebar{max-height:none} }
</style>
</head>
<body>
<header>
  <h1>Mouhtis AC Planner — Full</h1>
  <div class="small">Prototype — κάνε replace στο GitHub repo για live</div>
</header>

<div class="controls">
  <input id="file" type="file" accept="image/*" />
  <button id="drawRoom">Draw room</button>
  <button id="placeAC">Place AC (manual)</button>
  <button id="autoPlace">Auto place 2 AC</button>
  <button id="clear">Clear</button>
  <button id="calc">Calculate BTU</button>
  <button id="exportPdf">Export PDF</button>
</div>

<div class="panel">
  <div>
    <div id="canvasWrap"><canvas id="cv" width="1000" height="700"></canvas></div>
    <div class="small" style="margin-top:6px">Instructions: Upload floorplan → Draw rooms by dragging → fill room data on the right → Click Calculate → Auto place recommends 2 AC positions.</div>
  </div>

  <aside class="sidebar">
    <h3>Rooms</h3>
    <div id="roomsList">No rooms yet</div>

    <h3 style="margin-top:10px">Results</h3>
    <div id="results">Press Calculate</div>

    <h3 style="margin-top:10px">Models (VFM)</h3>
    <div id="modelsList">
      <table class="rooms-table">
        <thead><tr><th>Model</th><th>BTU</th><th>€</th><th>Dehum</th></tr></thead>
        <tbody id="modelsTbody"></tbody>
      </table>
    </div>
  </aside>
</div>

<footer>Έκδοση prototype — αν θέλεις, μετά βελτιώνουμε detection και export.</footer>

<script>
/* Full single-file prototype
 - draw rectangles as rooms on canvas
 - upload background image
 - enter parameters per room (area, height, windows, U, occupants, insulation)
 - calculate BTU (detailed)
 - auto-place 2 AC units by sorting BTU
 - suggest VFM models filtered by budget & dehumidify
 - export PDF (screenshot + report)
*/

// --- state
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
let bgImg = null;
let mode = 'select'; // draw/place/select
let isDown = false, start=null;
let lastPos = {x:0,y:0};
let rooms = []; // {x,y,w,h, name, area, height, windows, win_u, occupants, ins}
let acMarkers = []; // {x,y,roomIndex}
const W_TO_BTU = 3.412;
const BTU_PER_M2 = 341.2;

// sample models (VFM) - editable
const MODELS = [
  {brand:'Hisense Europa',btu:12000,price:330,dehum:true,warranty:5},
  {brand:'Hisense Europa',btu:9000,price:290,dehum:true,warranty:5},
  {brand:'Midea Xtreme',btu:12000,price:420,dehum:true,warranty:5},
  {brand:'Gree Mistral',btu:12000,price:480,dehum:true,warranty:3},
  {brand:'Inventor 9000',btu:9000,price:310,dehum:true,warranty:5}
];

// render models
function renderModels(){
  const tbody = document.getElementById('modelsTbody');
  tbody.innerHTML = '';
  MODELS.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.brand}</td><td>${m.btu}</td><td>${m.price}€</td><td>${m.dehum? 'Yes':'No'}</td>`;
    tbody.appendChild(tr);
  });
}
renderModels();

// helpers
function screenToCanvas(e){
  const r = cv.getBoundingClientRect();
  const x = (e.clientX - r.left) * (cv.width / r.width);
  const y = (e.clientY - r.top) * (cv.height / r.height);
  return {x,y};
}

// draw
function drawAll(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(bgImg){ ctx.drawImage(bgImg,0,0,cv.width,cv.height); } else { ctx.fillStyle='#fff'; ctx.fillRect(0,0,cv.width,cv.height); }
  rooms.forEach((r,i)=>{
    ctx.save();
    ctx.strokeStyle = '#1e88e5';
    ctx.lineWidth = 2;
    ctx.strokeRect(r.x,r.y,r.w,r.h);
    ctx.fillStyle = 'rgba(30,136,229,0.06)';
    ctx.fillRect(r.x,r.y,r.w,r.h);
    ctx.fillStyle = '#123';
    ctx.font = '14px Arial';
    ctx.fillText((r.name || 'Room '+(i+1)) + ' ' + (r.area? '('+r.area+' m²)':''), r.x+6, r.y+16);
    ctx.restore();
  });
  // AC dots
  acMarkers.forEach(m=>{
    ctx.beginPath();
    ctx.fillStyle = '#000';
    ctx.arc(m.x,m.y,8,0,Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // small label
    ctx.fillStyle='white';
    ctx.font='10px Arial';
    ctx.fillText('AC', m.x-8, m.y+4);
  });
}
drawAll();

// mouse
cv.addEventListener('mousemove', e=>{
  const p = screenToCanvas(e);
  lastPos = p;
  if(isDown && mode==='draw' && start){
    drawAll();
    ctx.save();
    ctx.strokeStyle='#4caf50';
    ctx.setLineDash([6,4]);
    ctx.strokeRect(start.x, start.y, p.x-start.x, p.y-start.y);
    ctx.restore();
  }
});
cv.addEventListener('mousedown', e=>{
  isDown = true;
  if(mode==='draw'){ start = screenToCanvas(e); }
  else if(mode==='place'){ const p=screenToCanvas(e); let idx=null; rooms.forEach((r,i)=>{ if(p.x>=r.x && p.x<=r.x+r.w && p.y>=r.y && p.y<=r.y+r.h) idx=i; }); acMarkers.push({x:p.x,y:p.y,roomIndex:idx}); drawAll(); renderRoomsList(); }
});
cv.addEventListener('mouseup', e=>{
  if(mode==='draw' && start){
    const p = screenToCanvas(e);
    // normalize
    const nx = Math.min(start.x,p.x), ny = Math.min(start.y,p.y);
    const nw = Math.abs(p.x - start.x), nh = Math.abs(p.y - start.y);
    rooms.push({x:nx,y:ny,w:nw,h:nh,name:'',area:'',height:2.7,windows:0,win_u:2.8,occupants:1,ins:1.0});
    start=null; drawAll(); renderRoomsList();
  }
  isDown=false;
});

// file upload
document.getElementById('file').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = function(){
      // scale canvas to image size (fit)
      const maxW = 1
