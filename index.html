<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mouhtis HVAC Suite</title>

<style>
  :root{
    --bg:#f5f6fa;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --accent:#0b74de;
    --accent-dark:#095fb6;
    --accent-soft:#dbeafe;
    --sidebar-bg:#0d1b2a;
    --sidebar-bg2:#1b263b;
  }

  *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
  }

  /* LOGIN SCREEN */
  #loginScreen{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(circle at top,#e0f2fe,#f5f6fa);
  }
  .login-card{
    background:#fff;
    padding:24px 22px;
    border-radius:16px;
    box-shadow:0 10px 25px rgba(15,23,42,0.18);
    max-width:320px;
    width:100%;
    text-align:center;
    border:1px solid #e5e7eb;
  }
  .login-title{
    font-size:22px;
    font-weight:700;
    margin-bottom:4px;
  }
  .login-sub{
    font-size:13px;
    color:var(--muted);
    margin-bottom:16px;
  }
  .login-input{
    width:100%;
    padding:9px 11px;
    border-radius:10px;
    border:1px solid var(--border);
    margin-bottom:10px;
    font-size:14px;
    text-align:center;
  }
  .login-input:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
  }
  .btn{
    padding:8px 16px;
    background:var(--accent);
    color:#fff;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
  }
  .btn:hover{background:var(--accent-dark);}
  .login-error{
    font-size:12px;
    color:#b91c1c;
    min-height:16px;
    margin-top:6px;
  }

  /* APP SHELL */
  #appShell{
    display:none;
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 230px;
    height: 100vh;
    background: var(--sidebar-bg);
    color: white;
    padding-top: 16px;
    display:flex;
    flex-direction:column;
  }

  .sidebar h2 {
    text-align: center;
    margin: 0 0 16px 0;
    font-weight: 600;
    font-size:18px;
  }

  .menu-btn {
    width: 90%;
    margin: 4px auto;
    padding: 10px 12px;
    background: var(--sidebar-bg2);
    color: white;
    border: none;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:6px;
  }

  .menu-btn span.icon{width:18px;text-align:center;}

  .menu-btn.active {
    background: #415a77;
  }

  .menu-btn:hover {
    background: #415a77;
  }

  .sidebar-footer{
    margin-top:auto;
    padding:10px 12px;
    font-size:11px;
    color:#9ca3af;
  }

  .main {
    margin-left: 250px;
    padding: 18px 18px 40px;
    max-width:1200px;
  }

  h1 {
    margin: 0 0 6px 0;
    font-size:22px;
  }
  h2{margin:0 0 8px 0;font-size:18px;}
  h3{margin:0 0 6px 0;font-size:15px;}

  .subtitle{
    font-size:12px;
    color:var(--muted);
    margin-bottom:12px;
  }

  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    border:1px solid var(--border);
  }

  .row{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }
  .col{
    flex:1;
    min-width:260px;
  }

  .btn.secondary{
    background:#fff;
    color:var(--accent);
    border:1px solid var(--accent-soft);
  }
  .btn.secondary:hover{
    background:var(--accent-soft);
  }
  .btn.small{font-size:12px;padding:5px 10px;}

  label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
    margin-bottom:2px;
  }
  input, select, textarea{
    width:100%;
    padding:7px 9px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:13px;
    outline:none;
  }
  textarea{resize:vertical;min-height:60px;}
  input:focus, select:focus, textarea:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
    background:#fff;
  }

  .search-box {
    padding: 9px 12px;
    width: 100%;
    max-width: 420px;
    border-radius: 999px;
    border: 1px solid #ccc;
    margin: 4px 0 10px;
    font-size:13px;
  }

  .search-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    justify-content:space-between;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th,td{
    padding:6px 4px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }
  th{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
  }

  .tag{
    display:inline-block;
    background:#eef2ff;
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
    color:#3730a3;
  }
  .pill{
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
  }
  .pill.green{background:#dcfce7;color:#166534;}
  .pill.red{background:#fee2e2;color:#b91c1c;}
  .pill.orange{background:#ffedd5;color:#9a3412;}

  .muted{font-size:12px;color:var(--muted);}
  .link{
    font-size:12px;
    color:var(--accent);
    cursor:pointer;
  }
  .link:hover{text-decoration:underline;}

  .img-preview{
    margin-top:8px;
    border-radius:8px;
    border:1px dashed #d1d5db;
    max-width:100%;
  }

  @media(max-width: 900px){
    .sidebar { width: 200px; }
    .main { margin-left: 210px; }
  }

  @media(max-width: 700px){
    .sidebar {
      position: relative;
      width: 100%;
      height: auto;
    }
    .main { margin-left: 0; padding:14px 12px 28px; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-title">Mouhtis HVAC Suite</div>
    <div class="login-sub">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Î¼ÏŒÎ½Î¿ Î¼Îµ ÎºÏ‰Î´Î¹ÎºÏŒ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚.</div>
    <input id="pwdInput" class="login-input" type="password" placeholder="ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚">
    <button id="loginBtn" class="btn">Î•Î¯ÏƒÎ¿Î´Î¿Ï‚</button>
    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- APP -->
<div id="appShell">
  <div class="sidebar">
    <h2>Mouhtis Suite</h2>
    <button class="menu-btn active" data-page="customers">
      <span class="icon">ğŸ‘¤</span> Î ÎµÎ»Î¬Ï„ÎµÏ‚
    </button>
    <button class="menu-btn" data-page="jobs">
      <span class="icon">ğŸ› ï¸</span> Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚
    </button>
    <button class="menu-btn" data-page="projects">
      <span class="icon">ğŸ“</span> Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î­ÏÎ³Î¿Ï…
    </button>
    <button class="menu-btn" data-page="studies">
      <span class="icon">ğŸ“</span> ÎœÎµÎ»Î­Ï„Î· ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï
    </button>

    <div class="sidebar-footer">
      Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÎµ Firebase Firestore (cloud).
    </div>
  </div>

  <div class="main">
    <div id="globalArea">
      <h1>Mouhtis HVAC Suite</h1>
      <div class="subtitle">Î ÎµÎ»Î¬Ï„ÎµÏ‚, ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚, ÎºÏŒÏƒÏ„Î· Î­ÏÎ³Ï‰Î½ & Î¼ÎµÎ»Î­Ï„ÎµÏ‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï ÏƒÎµ Î¼Î¯Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.</div>

      <div class="card">
        <div class="search-row">
          <div>
            <strong>Î“ÎµÎ½Î¹ÎºÎ® Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</strong><br>
            <span class="muted">Î¨Î¬Î¾Îµ ÏƒÎµ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚, ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚, Î­ÏÎ³Î±, Î¼ÎµÎ»Î­Ï„ÎµÏ‚.</span>
          </div>
        </div>
        <input id="globalSearch" class="search-box" placeholder="ÎŒÎ½Î¿Î¼Î±, Ï„Î·Î»Î­Ï†Ï‰Î½Î¿, Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·, Î­ÏÎ³Î¿, Î¼Î¿Î½Ï„Î­Î»Î¿ AC...">
        <div id="globalResults" class="muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î±ÎºÏŒÎ¼Î·.</div>
      </div>
    </div>

    <div id="pageContainer"></div>
  </div>
</div>

<script type="module">
/* ------------ FIREBASE ------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, setDoc,
  deleteDoc, doc, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAJlPDZktoQmDUIwQrCBsH_GLEhn5N6owE",
  authDomain: "mouhtis-suite.firebaseapp.com",
  projectId: "mouhtis-suite",
  storageBucket: "mouhtis-suite.firebasestorage.app",
  messagingSenderId: "1093547214312",
  appId: "1:1093547214312:web:83cc116f17b031f2ef105d",
  measurementId: "G-84HEW3XYX1"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ------------ HELPERS ------------- */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

let state = {
  customers: [],
  jobs: [],
  projects: [],
  studies: [],
  currentCustomerId:null,
  currentJobId:null,
  currentProjectId:null,
  currentStudyId:null
};

async function loadCollection(name){
  const colRef = collection(db, name);
  let qRef = colRef;
  try{ qRef = query(colRef, orderBy('createdAt','desc')); }catch(e){}
  const snap = await getDocs(qRef);
  return snap.docs.map(d=>({ id:d.id, ...d.data() }));
}

async function loadAllData(){
  const [customers,jobs,projects,studies] = await Promise.all([
    loadCollection('customers'),
    loadCollection('jobs'),
    loadCollection('projects'),
    loadCollection('studies')
  ]);
  state.customers = customers;
  state.jobs      = jobs;
  state.projects  = projects;
  state.studies   = studies;
}

/* ------------ DASHBOARD / GLOBAL SEARCH ------------- */
function performGlobalSearch(){
  const input = $('#globalSearch');
  const results = $('#globalResults');
  if(!input || !results) return;
  const q = input.value.trim().toLowerCase();
  if(!q){
    results.textContent = 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î±ÎºÏŒÎ¼Î·.';
    return;
  }
  let matches = [];

  state.customers.forEach(c=>{
    const text = (c.name||'')+' '+(c.phone||'')+' '+(c.address||'')+' '+(c.notes||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'Î ÎµÎ»Î¬Ï„Î·Ï‚', label:c.name, extra:c.phone||c.address||''});
    }
  });
  state.jobs.forEach(j=>{
    const client = state.customers.find(c=>c.id===j.customerId);
    const text = (j.title||'')+' '+(j.type||'')+' '+(j.notes||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'Î•ÏÎ³Î±ÏƒÎ¯Î±', label:j.title, extra:client?client.name:''});
    }
  });
  state.projects.forEach(p=>{
    const client = state.customers.find(c=>c.id===p.customerId);
    const text = (p.title||'')+' '+(p.location||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'ÎˆÏÎ³Î¿', label:p.title, extra:client?client.name:''});
    }
  });
  state.studies.forEach(s=>{
    const client = state.customers.find(c=>c.id===s.customerId);
    const text = (s.title||'')+' '+(s.summary||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'ÎœÎµÎ»Î­Ï„Î·', label:s.title, extra:client?client.name:''});
    }
  });

  if(!matches.length){
    results.textContent = 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.';
    return;
  }
  let html = '<ul class="muted" style="padding-left:18px;margin:4px 0;">';
  matches.slice(0,50).forEach(m=>{
    html += `<li><span class="tag">${m.type}</span> <strong>${m.label}</strong> ${m.extra?('â€” '+m.extra):''}</li>`;
  });
  html += '</ul>';
  results.innerHTML = html;
}

/* ------------ SELECTS (Î Î•Î›Î‘Î¤Î•Î£ / Î•Î¡Î“Î‘) ------------- */
function populateCustomerSelects(){
  const ids = ['job_customer','proj_customer','study_customer'];
  ids.forEach(id=>{
    const sel = $('#'+id);
    if(!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>';
    state.customers.forEach(c=>{
      const opt = document.createElement('option');
      opt.value=c.id;
      opt.textContent=c.name;
      sel.appendChild(opt);
    });
    if(prev) sel.value=prev;
  });

  const projSel = $('#study_project');
  if(projSel){
    const prev = projSel.value;
    projSel.innerHTML = '<option value="">â€” Î§Ï‰ÏÎ¯Ï‚ Î­ÏÎ³Î¿ â€”</option>';
    state.projects.forEach(p=>{
      const opt = document.createElement('option');
      opt.value=p.id;
      opt.textContent=p.title;
      projSel.appendChild(opt);
    });
    if(prev) projSel.value=prev;
  }
}

/* ------------ Î Î•Î›Î‘Î¤Î•Î£ ------------- */
function customersPageHtml(){
  return `
  <div class="card">
    <h2>Î ÎµÎ»Î¬Ï„ÎµÏ‚</h2>
    <div class="subtitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· ÎºÎ±Î¹ Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½ (cloud Firestore).</div>
    <div class="row">
      <div class="col">
        <h3>ÎÎ­Î¿Ï‚ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</h3>
        <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
        <input id="c_name" placeholder="Ï€.Ï‡. Î“Î¹Î¬Î½Î½Î·Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚">
        <label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</label>
        <input id="c_phone" placeholder="69xxxxxxx">
        <label>Email</label>
        <input id="c_email" placeholder="example@mail.com">
        <label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label>
        <input id="c_address" placeholder="ÎŸÎ´ÏŒÏ‚, Î±ÏÎ¹Î¸Î¼ÏŒÏ‚, Ï€ÏŒÎ»Î·">
        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="c_notes" placeholder="Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï‡ÏÏÎ¿Ï…, ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎºÏ„Î»."></textarea>
        <div style="margin-top:8px;">
          <button class="btn small" id="c_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="c_new">ÎÎ­Î¿Ï‚</button>
        </div>
        <div id="c_msg" class="muted" style="margin-top:4px;"></div>
      </div>
      <div class="col">
        <div class="search-row">
          <h3>Î›Î¯ÏƒÏ„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½</h3>
          <input id="c_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (ÏŒÎ½Î¿Î¼Î±, Ï„Î·Î», Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·)...">
        </div>
        <div id="c_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.</div>
      </div>
    </div>
  </div>`;
}

async function saveCustomer(){
  const nameEl = $('#c_name');
  if(!nameEl) return;
  const name = nameEl.value.trim();
  if(!name){ $('#c_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ½Î¿Î¼Î±.'; return; }
  const data = {
    name,
    phone: $('#c_phone').value.trim(),
    email: $('#c_email').value.trim(),
    address: $('#c_address').value.trim(),
    notes: $('#c_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentCustomerId){
    const ref = await addDoc(collection(db,'customers'), data);
    state.currentCustomerId = ref.id;
    state.customers.unshift({id:ref.id,...data});
  }else{
    const id = state.currentCustomerId;
    await setDoc(doc(db,'customers',id), data, {merge:true});
    const idx = state.customers.findIndex(c=>c.id===id);
    if(idx>=0) state.customers[idx] = {id,...state.customers[idx],...data};
  }
  $('#c_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderCustomerList();
  populateCustomerSelects();
}

function clearCustomerForm(){
  state.currentCustomerId=null;
  const n = $('#c_name'); if(!n) return;
  n.value='';
  $('#c_phone').value='';
  $('#c_email').value='';
  $('#c_address').value='';
  $('#c_notes').value='';
  $('#c_msg').textContent='';
}

async function deleteCustomer(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€ÎµÎ»Î¬Ï„Î·;'))return;
  await deleteDoc(doc(db,'customers',id));
  state.customers = state.customers.filter(c=>c.id!==id);
  state.jobs.forEach(j=>{ if(j.customerId===id) j.customerId=''; });
  state.projects.forEach(p=>{ if(p.customerId===id) p.customerId=''; });
  state.studies.forEach(s=>{ if(s.customerId===id) s.customerId=''; });
  renderCustomerList();
  populateCustomerSelects();
}

function renderCustomerList(){
  const wrap = $('#c_list');
  if(!wrap) return;
  const q = ($('#c_search')?.value || '').toLowerCase();
  let arr = state.customers.slice();
  if(q){
    arr = arr.filter(c=>
      (c.name||'').toLowerCase().includes(q) ||
      (c.phone||'').toLowerCase().includes(q) ||
      (c.address||'').toLowerCase().includes(q) ||
      (c.email||'').toLowerCase().includes(q)
    );
  }
  if(!arr.length){ wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.'; return; }
  let html = '<table><thead><tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î¤Î·Î»</th><th>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(c=>{
    html += `<tr>
      <td>${c.name}</td>
      <td>${c.phone||''}</td>
      <td>${c.address||''}</td>
      <td>
        <span class="link" data-edit="${c.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${c.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#c_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const c = state.customers.find(x=>x.id===id);
      if(!c) return;
      state.currentCustomerId=id;
      $('#c_name').value=c.name||'';
      $('#c_phone').value=c.phone||'';
      $('#c_email').value=c.email||'';
      $('#c_address').value=c.address||'';
      $('#c_notes').value=c.notes||'';
      $('#c_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î¬Ï„Î·.';
    };
  });
  $$('#c_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteCustomer(el.dataset.del);
  });
}

/* ------------ Î•Î¡Î“Î‘Î£Î™Î•Î£ ------------- */
function jobsPageHtml(){
  return `
  <div class="card">
    <h2>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h2>
    <div class="subtitle">Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·, Î²Î»Î¬Î²ÎµÏ‚, ÏƒÏ…Î½Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚.</div>
    <div class="row">
      <div class="col">
        <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</h3>
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="job_customer"></select>
        <label>Î¤ÏÏ€Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
        <select id="job_type">
          <option value="installation">Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</option>
          <option value="fault">Î’Î»Î¬Î²Î·</option>
          <option value="maintenance">Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·</option>
          <option value="other">Î†Î»Î»Î¿</option>
        </select>
        <label>Î¤Î¯Ï„Î»Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
        <input id="job_title" placeholder="Ï€.Ï‡. Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 12.000 BTU">
        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input id="job_date" type="date">
        <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
        <select id="job_status">
          <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î®</option>
          <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
          <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</option>
        </select>
        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="job_notes" placeholder="Î¤Î¹ Î­Î³Î¹Î½Îµ, Ï…Î»Î¹ÎºÎ¬, Ï‡ÏÏŒÎ½Î¿Ï‚, Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚."></textarea>
        <div style="margin-top:8px;">
          <button class="btn small" id="job_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="job_new">ÎÎ­Î±</button>
        </div>
        <div id="job_msg" class="muted" style="margin-top:4px;"></div>
      </div>
      <div class="col">
        <div class="search-row">
          <div>
            <h3>Î›Î¯ÏƒÏ„Î± ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½</h3>
            <span class="muted">Î¦Î¯Î»Ï„ÏÎ¿ & Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·.</span>
          </div>
        </div>
        <div class="row" style="margin-bottom:4px;">
          <div style="flex:1;min-width:120px;">
            <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
            <select id="job_filter">
              <option value="all">ÎŒÎ»ÎµÏ‚</option>
              <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚</option>
              <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
              <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</option>
            </select>
          </div>
          <div style="flex:2;min-width:160px;">
            <label>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</label>
            <input id="job_search" class="search-box" style="max-width:none;width:100%;" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚...">
          </div>
        </div>
        <div id="job_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.</div>
      </div>
    </div>
  </div>`;
}

async function saveJob(){
  const tEl = $('#job_title');
  if(!tEl) return;
  const title = tEl.value.trim();
  if(!title){ $('#job_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.'; return; }

  const data = {
    customerId: $('#job_customer').value || '',
    type: $('#job_type').value,
    title,
    date: $('#job_date').value || '',
    status: $('#job_status').value,
    notes: $('#job_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentJobId){
    const ref = await addDoc(collection(db,'jobs'), data);
    state.currentJobId = ref.id;
    state.jobs.unshift({id:ref.id,...data});
  }else{
    const id = state.currentJobId;
    await setDoc(doc(db,'jobs',id), data, {merge:true});
    const idx = state.jobs.findIndex(j=>j.id===id);
    if(idx>=0) state.jobs[idx]={id,...state.jobs[idx],...data};
  }
  $('#job_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderJobList();
}

function clearJobForm(){
  state.currentJobId=null;
  const t = $('#job_title'); if(!t) return;
  $('#job_customer').value='';
  $('#job_type').value='installation';
  t.value='';
  $('#job_date').value='';
  $('#job_status').value='open';
  $('#job_notes').value='';
  $('#job_msg').textContent='';
}

async function deleteJob(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚;'))return;
  await deleteDoc(doc(db,'jobs',id));
  state.jobs = state.jobs.filter(j=>j.id!==id);
  renderJobList();
}

function renderJobList(){
  const wrap = $('#job_list');
  if(!wrap) return;
  const filter = $('#job_filter')?.value || 'all';
  const q = ($('#job_search')?.value || '').toLowerCase();
  let arr = state.jobs.slice();
  if(filter!=='all') arr = arr.filter(j=>j.status===filter);
  if(q){
    arr = arr.filter(j=>{
      const client = state.customers.find(c=>c.id===j.customerId);
      return (j.title||'').toLowerCase().includes(q) ||
             (j.notes||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.';return;}
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>Î¤ÏÏ€Î¿Ï‚</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(j=>{
    const client = state.customers.find(c=>c.id===j.customerId);
    const typeLabel =
      j.type==='installation'?'Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·':
      j.type==='fault'?'Î’Î»Î¬Î²Î·':
      j.type==='maintenance'?'Î£Ï…Î½Ï„Î®ÏÎ·ÏƒÎ·':'Î†Î»Î»Î¿';
    const pill =
      j.status==='done' ? '<span class="pill green">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</span>' :
      j.status==='inprogress' ? '<span class="pill orange">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</span>' :
      '<span class="pill red">Î‘Î½Î¿Î¹Ï‡Ï„Î®</span>';
    html+=`<tr>
      <td>${j.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${j.date||''}</td>
      <td>${typeLabel}</td>
      <td>${pill}</td>
      <td>
        <span class="link" data-edit="${j.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${j.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#job_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const j = state.jobs.find(x=>x.id===id);
      if(!j) return;
      state.currentJobId=id;
      $('#job_customer').value=j.customerId||'';
      $('#job_type').value=j.type||'installation';
      $('#job_title').value=j.title||'';
      $('#job_date').value=j.date||'';
      $('#job_status').value=j.status||'open';
      $('#job_notes').value=j.notes||'';
      $('#job_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.';
    };
  });
  $$('#job_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteJob(el.dataset.del);
  });
}

/* ------------ Î”Î™Î‘Î§Î•Î™Î¡Î™Î£Î— Î•Î¡Î“ÎŸÎ¥ ------------- */
function projectsPageHtml(){
  return `
  <div class="card">
    <h2>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î­ÏÎ³Î¿Ï…</h2>
    <div class="subtitle">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÏŒÏƒÏ„Î¿Ï…Ï‚ Î±Î½Î¬ Î­ÏÎ³Î¿ (ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬, Î²Î¿Î·Î¸ÏŒÏ‚, Ï…Î»Î¹ÎºÎ¬ ÎºÎ»Ï€).</div>
    <div class="row">
      <div class="col">
        <h3>ÎÎ­Î¿ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï…</h3>
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="proj_customer"></select>
        <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î­ÏÎ³Î¿Ï…</label>
        <input id="proj_title" placeholder="Ï€.Ï‡. Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 3 ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½">
        <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
        <input id="proj_location" placeholder="Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î­ÏÎ³Î¿Ï…">
        <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
        <input id="proj_date" type="date">

        <h3 style="margin-top:12px;">ÎšÏŒÏƒÏ„Î·</h3>
        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ (â‚¬)</label>
        <input id="proj_cost_units" type="number" min="0" step="0.01">

        <label>ÎšÏŒÏƒÏ„Î¿Ï‚ Ï…Î»Î¹ÎºÏÎ½ (â‚¬)</label>
        <input id="proj_cost_materials" type="number" min="0" step="0.01">

        <label>ÎÏÎµÏ‚ Î²Î¿Î·Î¸Î¿Ï</label>
        <input id="proj_helper_hours" type="number" min="0" step="0.5">

        <label>Î©ÏÎ¿Î¼Î¯ÏƒÎ¸Î¹Î¿ Î²Î¿Î·Î¸Î¿Ï (â‚¬ / ÏÏÎ±)</label>
        <input id="proj_helper_rate" type="number" min="0" step="0.5" value="5">

        <label>Î†Î»Î»Î± ÎºÏŒÏƒÏ„Î· (Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ¬ ÎºÎ»Ï€, â‚¬)</label>
        <input id="proj_cost_other" type="number" min="0" step="0.01">

        <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
        <textarea id="proj_notes" placeholder="Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ® Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½, Î¼Î¬ÏÎºÎµÏ‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½ ÎºÎ»Ï€."></textarea>

        <div class="muted" id="proj_total_view" style="margin-top:8px;">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: 0 â‚¬</div>

        <div style="margin-top:8px;">
          <button class="btn small" id="proj_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="proj_new">ÎÎ­Î¿</button>
        </div>
        <div id="proj_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="col">
        <div class="search-row">
          <div>
            <h3>ÎˆÏÎ³Î±</h3>
            <span class="muted">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· & Ï†Î¯Î»Ï„ÏÎ±.</span>
          </div>
        </div>
        <input id="proj_search" class="search-box" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·...">
        <div id="proj_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.</div>
      </div>
    </div>
  </div>`;
}

function calcProjectTotal(){
  const units = parseFloat($('#proj_cost_units')?.value || '0') || 0;
  const mats  = parseFloat($('#proj_cost_materials')?.value || '0') || 0;
  const hH    = parseFloat($('#proj_helper_hours')?.value || '0') || 0;
  const hR    = parseFloat($('#proj_helper_rate')?.value || '0') || 0;
  const other = parseFloat($('#proj_cost_other')?.value || '0') || 0;
  const totalHelper = hH * hR;
  const total = units + mats + totalHelper + other;
  const view = $('#proj_total_view');
  if(view) view.textContent = `Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎºÏŒÏƒÏ„Î¿Ï‚: ${total.toFixed(2)} â‚¬ (Î’Î¿Î·Î¸ÏŒÏ‚: ${totalHelper.toFixed(2)} â‚¬)`;
  return total;
}

async function saveProject(){
  const tEl = $('#proj_title');
  if(!tEl) return;
  const title = tEl.value.trim();
  if(!title){ $('#proj_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î­ÏÎ³Î¿Ï….'; return; }
  const total = calcProjectTotal();
  const data = {
    customerId: $('#proj_customer').value || '',
    title,
    location: $('#proj_location').value.trim(),
    date: $('#proj_date').value || '',
    costUnits: parseFloat($('#proj_cost_units').value||'0')||0,
    costMaterials: parseFloat($('#proj_cost_materials').value||'0')||0,
    helperHours: parseFloat($('#proj_helper_hours').value||'0')||0,
    helperRate: parseFloat($('#proj_helper_rate').value||'0')||0,
    costOther: parseFloat($('#proj_cost_other').value||'0')||0,
    costTotal: total,
    notes: $('#proj_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentProjectId){
    const ref = await addDoc(collection(db,'projects'), data);
    state.currentProjectId = ref.id;
    state.projects.unshift({id:ref.id,...data});
  }else{
    const id = state.currentProjectId;
    await setDoc(doc(db,'projects',id), data, {merge:true});
    const idx = state.projects.findIndex(p=>p.id===id);
    if(idx>=0) state.projects[idx]={id,...state.projects[idx],...data};
  }
  $('#proj_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderProjectList();
  populateCustomerSelects();
}

function clearProjectForm(){
  state.currentProjectId=null;
  const t = $('#proj_title'); if(!t) return;
  $('#proj_customer').value='';
  t.value='';
  $('#proj_location').value='';
  $('#proj_date').value='';
  $('#proj_cost_units').value='';
  $('#proj_cost_materials').value='';
  $('#proj_helper_hours').value='';
  $('#proj_helper_rate').value='5';
  $('#proj_cost_other').value='';
  $('#proj_notes').value='';
  $('#proj_msg').textContent='';
  calcProjectTotal();
}

async function deleteProject(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Î­ÏÎ³Î¿Ï…;'))return;
  await deleteDoc(doc(db,'projects',id));
  state.projects = state.projects.filter(p=>p.id!==id);
  renderProjectList();
  populateCustomerSelects();
}

function renderProjectList(){
  const wrap = $('#proj_list');
  if(!wrap) return;
  const q = ($('#proj_search')?.value || '').toLowerCase();
  let arr = state.projects.slice();
  if(q){
    arr = arr.filter(p=>{
      const client = state.customers.find(c=>c.id===p.customerId);
      return (p.title||'').toLowerCase().includes(q) ||
             (p.location||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.';return;}
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th><th></th></tr></thead><tbody>';
  arr.forEach(p=>{
    const client = state.customers.find(c=>c.id===p.customerId);
    html += `<tr>
      <td>${p.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${p.date||''}</td>
      <td>${(p.costTotal||0).toFixed ? p.costTotal.toFixed(2) : Number(p.costTotal||0).toFixed(2)}</td>
      <td>
        <span class="link" data-edit="${p.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${p.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#proj_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const p = state.projects.find(x=>x.id===id);
      if(!p) return;
      state.currentProjectId=id;
      $('#proj_customer').value=p.customerId||'';
      $('#proj_title').value=p.title||'';
      $('#proj_location').value=p.location||'';
      $('#proj_date').value=p.date||'';
      $('#proj_cost_units').value=p.costUnits||'';
      $('#proj_cost_materials').value=p.costMaterials||'';
      $('#proj_helper_hours').value=p.helperHours||'';
      $('#proj_helper_rate').value=p.helperRate||'';
      $('#proj_cost_other').value=p.costOther||'';
      $('#proj_notes').value=p.notes||'';
      calcProjectTotal();
      $('#proj_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï….';
    };
  });
  $$('#proj_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteProject(el.dataset.del);
  });
}

/* ------------ ÎœÎ•Î›Î•Î¤Î— ÎšÎ›Î™ÎœÎ‘Î¤Î™Î£ÎœÎŸÎ¥ ------------- */
function studiesPageHtml(){
  return `
  <div class="card">
    <h2>ÎœÎµÎ»Î­Ï„Î· ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï</h2>
    <div class="subtitle">ÎœÎµÎ»Î­Ï„Î· BTU, Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Î¬Î´Ï‰Î½ & ÎºÎ¬Ï„Î¿ÏˆÎ· Ï‡ÏÏÎ¿Ï….</div>
    <div class="row">
      <div class="col">
        <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚</h3>
        <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î¼ÎµÎ»Î­Ï„Î·Ï‚</label>
        <input id="study_title" placeholder="Ï€.Ï‡. ÎœÎµÎ»Î­Ï„Î· Î´Î¹Î±Î¼ÎµÏÎ¯ÏƒÎ¼Î±Ï„Î¿Ï‚ 85mÂ²">
        <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
        <select id="study_customer"></select>
        <label>Î£Ï‡ÎµÏ„Î¹ÎºÏŒ Î­ÏÎ³Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
        <select id="study_project"></select>

        <label>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎµÎ¼Î²Î±Î´ÏŒÎ½ Ï‡ÏÏÎ¿Ï… (mÂ²)</label>
        <input id="study_area" type="number" min="0" step="1">

        <label>Î§ÏÎ®ÏƒÎ· Ï‡ÏÏÎ¿Ï…</label>
        <select id="study_usage">
          <option value="home">ÎšÎ±Ï„Î¿Î¹ÎºÎ¯Î±</option>
          <option value="office">Î“ÏÎ±Ï†ÎµÎ¯Î¿</option>
          <option value="shop">ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±</option>
        </select>

        <label>Î ÏÎ¿ÏƒÎ±Î½Î±Ï„Î¿Î»Î¹ÏƒÎ¼ÏŒÏ‚ / Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚ Î¸ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·Ï‚</label>
        <textarea id="study_insulation" placeholder="Ï€.Ï‡. Î”Ï…Ï„Î¹ÎºÏŒ ÏƒÎ±Î»ÏŒÎ½Î¹, Î¼Î­Ï„ÏÎ¹Î± Î¸ÎµÏÎ¼Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ·, Î¼ÎµÎ³Î¬Î»Î± Î±Î½Î¿Î¯Î³Î¼Î±Ï„Î± ÎºÏ„Î»."></textarea>

        <label>Upload ÎºÎ¬Ï„Î¿ÏˆÎ·Ï‚ (Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î®)</label>
        <input id="study_plan" type="file" accept="image/*">
        <img id="study_plan_preview" class="img-preview" style="display:none;"/>

        <label>Î£ÏÎ½Î¿ÏˆÎ· / BTU / Î ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Î¬Î´Ï‰Î½</label>
        <textarea id="study_summary" placeholder="Î— ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î¸Î± Ï€ÏÎ¿Ï„ÎµÎ¯Î½ÎµÎ¹ Î¼Î¿Î½Î¬Î´ÎµÏ‚ Î±Ï†Î¿Ï Ï€Î±Ï„Î®ÏƒÎµÎ¹Ï‚ 'Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚'..."></textarea>

        <div style="margin-top:8px;">
          <button class="btn small" id="study_calc">Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ & Ï€ÏÎ¿Ï„Î¬ÏƒÎµÎ¹Ï‚</button>
        </div>

        <div style="margin-top:8px;">
          <button class="btn small" id="study_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
          <button class="btn secondary small" id="study_new">ÎÎ­Î±</button>
        </div>
        <div id="study_msg" class="muted" style="margin-top:4px;"></div>
      </div>

      <div class="col">
        <div class="search-row">
          <div>
            <h3>Î‘ÏÏ‡ÎµÎ¯Î¿ Î¼ÎµÎ»ÎµÏ„ÏÎ½</h3>
            <span class="muted">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¼Îµ Ï„Î¯Ï„Î»Î¿, Ï€ÎµÎ»Î¬Ï„Î· Î® Î­ÏÎ³Î¿.</span>
          </div>
        </div>
        <input id="study_search" class="search-box" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Î­ÏÎ³Î¿...">
        <div id="study_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÎµÎ»Î­Ï„ÎµÏ‚.</div>
      </div>
    </div>
  </div>`;
}

function estimateBTU(area,usage,insulText){
  const m2 = area || 0;
  let per_m2 = 400; // Î²Î±ÏƒÎ¹ÎºÏŒ
  if(usage==='office') per_m2 = 450;
  if(usage==='shop')  per_m2 = 500;
  if(insulText.toLowerCase().includes('ÎºÎ±Î»Î®')) per_m2 -= 40;
  if(insulText.toLowerCase().includes('ÎºÎ±ÎºÎ®') || insulText.toLowerCase().includes('Ï‡Ï‰ÏÎ¯Ï‚')) per_m2 += 60;
  const total = m2 * per_m2;
  return Math.round(total/1000)*1000;
}

function suggestUnits(totalBTU){
  if(!totalBTU) return 'Î”ÎµÎ½ Ï…Ï€Î¿Î»Î¿Î³Î¯ÏƒÏ„Î·ÎºÎµ BTU.';
  const units = [];
  let remaining = totalBTU;
  while(remaining>0){
    if(remaining>24000){ units.push(24000); remaining-=24000; }
    else if(remaining>18000){ units.push(18000); remaining-=18000; }
    else if(remaining>12000){ units.push(12000); remaining-=12000; }
    else if(remaining>9000){ units.push(9000); remaining-=9000; }
    else { units.push(7000); remaining-=7000; }
  }
  const models = units.map(b=>{
    if(b<=9000) return b+' BTU: 1 x 9.000 BTU Inverter A+++ (ÏƒÎ±Î»ÏŒÎ½Î¹/Ï…Ï€Î½Î¿Î´Ï‰Î¼Î¬Ï„Î¹Î¿)';
    if(b<=12000) return b+' BTU: 1 x 12.000 BTU Inverter A+++';
    if(b<=18000) return b+' BTU: 1 x 18.000 BTU Inverter A+++';
    return b+' BTU: 1 x 24.000 BTU Inverter A+++';
  });
  return `Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Ï†Î¿ÏÏ„Î¯Î¿ ~${totalBTU.toLocaleString()} BTU.\nÎ ÏÎ¿Ï„ÎµÎ¹Î½ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¼Î¿Î½Î¬Î´ÎµÏ‚:\n- ${models.join('\n- ')}`;
}

function handleStudyCalc(){
  const area = parseFloat($('#study_area')?.value||'0')||0;
  const usage = $('#study_usage')?.value || 'home';
  const txt   = $('#study_insulation')?.value || '';
  const summary = $('#study_summary');
  const totalBTU = estimateBTU(area,usage,txt);
  const text = suggestUnits(totalBTU);
  if(summary){
    summary.value = `${text}\n\nÎ•Ï€Î¹Ï€Î»Î­Î¿Î½ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚:\n${summary.value||''}`;
  }
}

/* CRUD STUDIES */
async function saveStudy(){
  const tEl = $('#study_title');
  if(!tEl) return;
  const title = tEl.value.trim();
  if(!title){ $('#study_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î¼ÎµÎ»Î­Ï„Î·Ï‚.'; return; }
  const data = {
    title,
    customerId: $('#study_customer').value || '',
    projectId: $('#study_project').value || '',
    area: parseFloat($('#study_area').value||'0')||0,
    usage: $('#study_usage').value || 'home',
    insulation: $('#study_insulation').value.trim(),
    summary: $('#study_summary').value.trim(),
    createdAt: serverTimestamp()
  };
  if(!state.currentStudyId){
    const ref = await addDoc(collection(db,'studies'), data);
    state.currentStudyId = ref.id;
    state.studies.unshift({id:ref.id,...data});
  }else{
    const id = state.currentStudyId;
    await setDoc(doc(db,'studies',id), data, {merge:true});
    const idx = state.studies.findIndex(s=>s.id===id);
    if(idx>=0) state.studies[idx]={id,...state.studies[idx],...data};
  }
  $('#study_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderStudyList();
  populateCustomerSelects();
}

function clearStudyForm(){
  state.currentStudyId=null;
  const t = $('#study_title'); if(!t) return;
  t.value='';
  $('#study_customer').value='';
  $('#study_project').value='';
  $('#study_area').value='';
  $('#study_usage').value='home';
  $('#study_insulation').value='';
  $('#study_summary').value='';
  $('#study_plan').value=null;
  const img = $('#study_plan_preview');
  if(img){ img.style.display='none'; img.src=''; }
  $('#study_msg').textContent='';
}

async function deleteStudy(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Î¼ÎµÎ»Î­Ï„Î·Ï‚;'))return;
  await deleteDoc(doc(db,'studies',id));
  state.studies = state.studies.filter(s=>s.id!==id);
  renderStudyList();
}

function renderStudyList(){
  const wrap = $('#study_list');
  if(!wrap) return;
  const q = ($('#study_search')?.value || '').toLowerCase();
  let arr = state.studies.slice();
  if(q){
    arr = arr.filter(s=>{
      const client = state.customers.find(c=>c.id===s.customerId);
      const proj = state.projects.find(p=>p.id===s.projectId);
      return (s.title||'').toLowerCase().includes(q) ||
             (s.summary||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q) ||
             (proj?.title||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÎµÎ»Î­Ï„ÎµÏ‚.';return;}
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>ÎˆÏÎ³Î¿</th><th></th></tr></thead><tbody>';
  arr.forEach(s=>{
    const client = state.customers.find(c=>c.id===s.customerId);
    const proj = state.projects.find(p=>p.id===s.projectId);
    html+=`<tr>
      <td>${s.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${proj?proj.title:'â€”'}</td>
      <td>
        <span class="link" data-edit="${s.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${s.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#study_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const s = state.studies.find(x=>x.id===id);
      if(!s) return;
      state.currentStudyId=id;
      $('#study_title').value=s.title||'';
      $('#study_customer').value=s.customerId||'';
      $('#study_project').value=s.projectId||'';
      $('#study_area').value=s.area||'';
      $('#study_usage').value=s.usage||'home';
      $('#study_insulation').value=s.insulation||'';
      $('#study_summary').value=s.summary||'';
      $('#study_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚.';
    };
  });
  $$('#study_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteStudy(el.dataset.del);
  });
}

/* ------------ PAGE RENDER / NAV ------------- */
function renderPage(page){
  const container = $('#pageContainer');
  if(!container) return;
  let html='';
  if(page==='customers') html = customersPageHtml();
  else if(page==='jobs') html = jobsPageHtml();
  else if(page==='projects') html = projectsPageHtml();
  else if(page==='studies') html = studiesPageHtml();
  container.innerHTML=html;

  if(page==='customers'){
    populateCustomerSelects();
    renderCustomerList();
    $('#c_save').onclick = saveCustomer;
    $('#c_new').onclick  = clearCustomerForm;
    $('#c_search').oninput = renderCustomerList;
  }
  if(page==='jobs'){
    populateCustomerSelects();
    renderJobList();
    $('#job_save').onclick = saveJob;
    $('#job_new').onclick  = clearJobForm;
    $('#job_filter').onchange = renderJobList;
    $('#job_search').oninput = renderJobList;
  }
  if(page==='projects'){
    populateCustomerSelects();
    renderProjectList();
    $('#proj_save').onclick = saveProject;
    $('#proj_new').onclick  = clearProjectForm;
    $('#proj_search').oninput = renderProjectList;
    ['proj_cost_units','proj_cost_materials','proj_helper_hours','proj_helper_rate','proj_cost_other']
      .forEach(id=>{
        const el = $('#'+id);
        if(el) el.oninput = calcProjectTotal;
      });
    calcProjectTotal();
  }
  if(page==='studies'){
    populateCustomerSelects();
    renderStudyList();
    $('#study_save').onclick = saveStudy;
    $('#study_new').onclick  = clearStudyForm;
    $('#study_search').oninput = renderStudyList;
    $('#study_calc').onclick = handleStudyCalc;
    const fileInput = $('#study_plan');
    if(fileInput){
      fileInput.onchange = e=>{
        const file = e.target.files[0];
        const img = $('#study_plan_preview');
        if(file && img){
          const reader = new FileReader();
          reader.onload = ev=>{
            img.src = ev.target.result;
            img.style.display='block';
          };
          reader.readAsDataURL(file);
        }
      };
    }
  }
}

function setActivePage(page){
  $$('.menu-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.page===page);
  });
  renderPage(page);
}

/* ------------ LOGIN ------------- */
const PASSWORD = 'fgb0911+';
$('#loginBtn').onclick = ()=>{
  const val = $('#pwdInput').value;
  const err = $('#loginError');
  if(val===PASSWORD){
    err.textContent='';
    $('#loginScreen').style.display='none';
    $('#appShell').style.display='block';
    startApp();
  }else{
    err.textContent='Î›Î¬Î¸Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚.';
  }
};
$('#pwdInput').addEventListener('keydown',e=>{
  if(e.key==='Enter') $('#loginBtn').click();
});

/* ------------ INIT APP ------------- */
async function startApp(){
  await loadAllData();
  $$('.menu-btn').forEach(btn=>{
    btn.onclick = ()=> setActivePage(btn.dataset.page);
  });
  setActivePage('customers');
  const gs = $('#globalSearch');
  if(gs) gs.addEventListener('input', performGlobalSearch);
}
</script>

</body>
</html>
