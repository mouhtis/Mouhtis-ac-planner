<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mouhtis HVAC Suite</title>

<style>
  :root{
    --bg:#f5f6fa;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --accent:#0b74de;
    --accent-dark:#095fb6;
    --accent-soft:#dbeafe;
    --sidebar-bg:#0d1b2a;
    --sidebar-bg2:#1b263b;
  }

  *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}

  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
  }

  /* ---------- SIDEBAR ---------- */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 230px;
    height: 100vh;
    background: var(--sidebar-bg);
    color: white;
    padding-top: 16px;
    display:flex;
    flex-direction:column;
  }

  .sidebar h2 {
    text-align: center;
    margin: 0 0 16px 0;
    font-weight: 600;
    font-size:18px;
  }

  .menu-btn {
    width: 90%;
    margin: 4px auto;
    padding: 10px 12px;
    background: var(--sidebar-bg2);
    color: white;
    border: none;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:6px;
  }

  .menu-btn span.icon{width:18px;text-align:center;}

  .menu-btn.active {
    background: #415a77;
  }

  .menu-btn:hover {
    background: #415a77;
  }

  .sidebar-footer{
    margin-top:auto;
    padding:10px 12px;
    font-size:11px;
    color:#9ca3af;
  }

  /* ---------- MAIN AREA ---------- */
  .main {
    margin-left: 250px;
    padding: 18px 18px 40px;
    max-width:1200px;
  }

  h1 {
    margin: 0 0 6px 0;
    font-size:22px;
  }
  h2{margin:0 0 8px 0;font-size:18px;}
  h3{margin:0 0 6px 0;font-size:15px;}

  .subtitle{
    font-size:12px;
    color:var(--muted);
    margin-bottom:12px;
  }

  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    border:1px solid var(--border);
  }

  .row{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }
  .col{
    flex:1;
    min-width:260px;
  }

  /* ---------- BUTTONS (ÎœÎ Î›Î•) ---------- */
  .btn {
    padding: 8px 16px;
    background: var(--accent);
    color: white;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    margin: 4px 4px 4px 0;
    font-weight: 600;
    font-size:13px;
  }
  .btn:hover {
    background: var(--accent-dark);
  }
  .btn.secondary{
    background:#fff;
    color:var(--accent);
    border:1px solid var(--accent-soft);
  }
  .btn.secondary:hover{
    background:var(--accent-soft);
  }
  .btn.small{font-size:12px;padding:5px 10px;}

  /* ---------- INPUTS / FORMS ---------- */
  label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-top:6px;
    margin-bottom:2px;
  }
  input, select, textarea{
    width:100%;
    padding:7px 9px;
    border-radius:8px;
    border:1px solid var(--border);
    font-size:13px;
    outline:none;
  }
  textarea{resize:vertical;min-height:60px;}
  input:focus, select:focus, textarea:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 1px var(--accent-soft);
    background:#fff;
  }

  /* ---------- SEARCH ---------- */
  .search-box {
    padding: 9px 12px;
    width: 100%;
    max-width: 420px;
    border-radius: 999px;
    border: 1px solid #ccc;
    margin: 4px 0 10px;
    font-size:13px;
  }

  .search-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    justify-content:space-between;
  }

  /* ---------- TABLES ---------- */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  th,td{
    padding:6px 4px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }
  th{
    font-size:12px;
    color:var(--muted);
    font-weight:600;
  }

  .tag{
    display:inline-block;
    background:#eef2ff;
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
    color:#3730a3;
  }
  .pill{
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
  }
  .pill.green{background:#dcfce7;color:#166534;}
  .pill.red{background:#fee2e2;color:#b91c1c;}
  .pill.orange{background:#ffedd5;color:#9a3412;}

  .muted{font-size:12px;color:var(--muted);}
  .link{
    font-size:12px;
    color:var(--accent);
    cursor:pointer;
  }
  .link:hover{text-decoration:underline;}

  @media(max-width: 900px){
    .sidebar { width: 200px; }
    .main { margin-left: 210px; }
  }

  @media(max-width: 700px){
    .sidebar {
      position: relative;
      width: 100%;
      height: auto;
    }
    .main { margin-left: 0; padding:14px 12px 28px; }
  }
</style>

</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>Mouhtis Suite</h2>

  <button class="menu-btn active" data-page="dashboard">
    <span class="icon">ğŸ“Š</span> Dashboard
  </button>
  <button class="menu-btn" data-page="customers">
    <span class="icon">ğŸ‘¤</span> Î ÎµÎ»Î¬Ï„ÎµÏ‚
  </button>
  <button class="menu-btn" data-page="projects">
    <span class="icon">ğŸ“</span> ÎˆÏÎ³Î±
  </button>
  <button class="menu-btn" data-page="tasks">
    <span class="icon">ğŸ› ï¸</span> Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚
  </button>
  <button class="menu-btn" data-page="studies">
    <span class="icon">ğŸ“</span> ÎœÎµÎ»Î­Ï„ÎµÏ‚
  </button>

  <div class="sidebar-footer">
    Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ ÏƒÏ„Î· Î²Î¬ÏƒÎ· Firebase Firestore Ï„Î¿Ï… project "mouhtis-suite".
  </div>
</div>

<!-- MAIN AREA -->
<div class="main">
  <!-- GLOBAL HEADER + SEARCH -->
  <div id="globalArea">
    <h1>Mouhtis HVAC Suite</h1>
    <div class="subtitle">Î ÎµÎ»Î¬Ï„ÎµÏ‚, Î­ÏÎ³Î±, ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚ & Î¼ÎµÎ»Î­Ï„ÎµÏ‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï ÏƒÎµ Î¼Î¯Î± ÎµÏ†Î±ÏÎ¼Î¿Î³Î®.</div>

    <div class="card">
      <div class="search-row">
        <div>
          <strong>Î“ÎµÎ½Î¹ÎºÎ® Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</strong><br>
          <span class="muted">Î¨Î¬Î¾Îµ ÏƒÎµ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚, Î­ÏÎ³Î±, ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚, Î¼ÎµÎ»Î­Ï„ÎµÏ‚ (ÏŒÎ½Î¿Î¼Î±, Ï„Î·Î», Ï„Î¯Ï„Î»Î¿, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚).</span>
        </div>
      </div>
      <input id="globalSearch" class="search-box" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»ÏŒÎ³Î·ÏƒÎµ ÏŒÎ½Î¿Î¼Î±, Ï„Î·Î»Î­Ï†Ï‰Î½Î¿, Î­ÏÎ³Î¿, Î¼Î¿Î½Ï„Î­Î»Î¿ AC..." />
      <div id="globalResults" class="muted">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î±ÎºÏŒÎ¼Î·.</div>
    </div>
  </div>

  <!-- PAGE CONTAINER -->
  <div id="pageContainer"></div>
</div>

<script type="module">
/* ---------- FIREBASE IMPORTS ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, setDoc,
  deleteDoc, doc, serverTimestamp, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";

/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAJlPDZktoQmDUIwQrCBsH_GLEhn5N6owE",
  authDomain: "mouhtis-suite.firebaseapp.com",
  projectId: "mouhtis-suite",
  storageBucket: "mouhtis-suite.firebasestorage.app",
  messagingSenderId: "1093547214312",
  appId: "1:1093547214312:web:83cc116f17b031f2ef105d",
  measurementId: "G-84HEW3XYX1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const analytics = getAnalytics(app);

/* ---------- HELPERS ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

let state = {
  customers: [],
  projects: [],
  tasks: [],
  studies: [],
  currentCustomerId:null,
  currentProjectId:null,
  currentTaskId:null,
  currentStudyId:null
};

/* ---------- LOAD FROM FIRESTORE ---------- */
async function loadCollection(name){
  const colRef = collection(db, name);
  let q = colRef;
  try{
    q = query(colRef, orderBy('createdAt','desc'));
  }catch(e){}
  const snap = await getDocs(q);
  return snap.docs.map(d=>({ id:d.id, ...d.data() }));
}

async function loadStateFromFirestore(){
  const [customers, projects, tasks, studies] = await Promise.all([
    loadCollection('customers'),
    loadCollection('projects'),
    loadCollection('tasks'),
    loadCollection('studies')
  ]);
  state.customers = customers;
  state.projects = projects;
  state.tasks = tasks;
  state.studies = studies;
}

/* ---------- UI RENDER HELPERS ---------- */
function renderDashboardSummary(){
  const container = $('#dashboardSummary');
  if(!container) return;
  const openTasks = state.tasks.filter(t=>t.status!=='done').length;
  const openProjects = state.projects.filter(p=>p.status!=='done').length;
  container.innerHTML = `
    <p>Î ÎµÎ»Î¬Ï„ÎµÏ‚: <strong>${state.customers.length}</strong></p>
    <p>ÎˆÏÎ³Î±: <strong>${state.projects.length}</strong> (ÎµÎºÎºÏÎµÎ¼Î®: ${openProjects})</p>
    <p>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚: <strong>${state.tasks.length}</strong> (Î±Î½Î¿Î¹Ï‡Ï„Î­Ï‚: ${openTasks})</p>
    <p>ÎœÎµÎ»Î­Ï„ÎµÏ‚: <strong>${state.studies.length}</strong></p>
  `;
}

function renderDashboard(){
  const c_last = state.customers.slice(0,5);
  const p_last = state.projects.slice(0,5);
  const t_last = state.tasks.slice(0,5);

  let customersHtml = c_last.length ? '<ul class="muted" style="padding-left:18px;margin:4px 0;">' : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.';
  c_last.forEach(c=>{
    customersHtml += `<li>${c.name} â€” ${c.phone||''}</li>`;
  });
  if(c_last.length) customersHtml += '</ul>';

  let projectsHtml = p_last.length ? '<ul class="muted" style="padding-left:18px;margin:4px 0;">' : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.';
  p_last.forEach(p=>{
    const client = state.customers.find(c=>c.id===p.customerId);
    projectsHtml += `<li>${p.title} â€” ${client?client.name:'â€”'}</li>`;
  });
  if(p_last.length) projectsHtml += '</ul>';

  let tasksHtml = t_last.length ? '<ul class="muted" style="padding-left:18px;margin:4px 0;">' : 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.';
  t_last.forEach(t=>{
    const client = state.customers.find(c=>c.id===t.customerId);
    tasksHtml += `<li>${t.title} â€” ${client?client.name:'â€”'} (${t.status==='done'?'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·':'Î•ÎºÎºÏÎµÎ¼ÎµÎ¯'})</li>`;
  });
  if(t_last.length) tasksHtml += '</ul>';

  return `
    <div class="card">
      <h2>Dashboard</h2>
      <div class="subtitle">Î£ÏÎ½Î¿ÏˆÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½, Î­ÏÎ³Ï‰Î½, ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½ ÎºÎ±Î¹ Î¼ÎµÎ»ÎµÏ„ÏÎ½.</div>
      <div id="dashboardSummary"></div>
    </div>
    <div class="row">
      <div class="col">
        <div class="card">
          <h3>Î ÏÏŒÏƒÏ†Î±Ï„Î¿Î¹ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚</h3>
          ${customersHtml}
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>Î ÏÏŒÏƒÏ†Î±Ï„Î± Î­ÏÎ³Î±</h3>
          ${projectsHtml}
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h3>Î ÏÏŒÏƒÏ†Î±Ï„ÎµÏ‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h3>
          ${tasksHtml}
        </div>
      </div>
    </div>
  `;
}

/* ---------- PAGES TEMPLATES ---------- */
function renderCustomersPage(){
  return `
    <div class="card">
      <h2>Î ÎµÎ»Î¬Ï„ÎµÏ‚</h2>
      <div class="subtitle">ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· ÎºÎ±Î¹ Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÎµÎ»Î±Ï„ÏÎ½ (Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ÏƒÎµ Firestore).</div>
      <div class="row">
        <div class="col">
          <h3>ÎÎ­Î¿Ï‚ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î¬Ï„Î·</h3>
          <label>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</label>
          <input id="c_name" placeholder="Ï€.Ï‡. Î“Î¹Î¬Î½Î½Î·Ï‚ Î Î±Ï€Î±Î´ÏŒÏ€Î¿Ï…Î»Î¿Ï‚">
          <label>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</label>
          <input id="c_phone" placeholder="69xxxxxxx">
          <label>Email</label>
          <input id="c_email" placeholder="example@mail.com">
          <label>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</label>
          <input id="c_address" placeholder="ÎŸÎ´ÏŒÏ‚, Î±ÏÎ¹Î¸Î¼ÏŒÏ‚, Ï€ÏŒÎ»Î·">
          <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
          <textarea id="c_notes" placeholder="Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚ Ï‡ÏÏÎ¿Ï…, ÏÏÎµÏ‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎºÏ„Î»."></textarea>
          <div style="margin-top:8px;">
            <button class="btn small" id="c_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            <button class="btn secondary small" id="c_new">ÎÎ­Î¿Ï‚</button>
          </div>
          <div id="c_msg" class="muted" style="margin-top:4px;"></div>
        </div>
        <div class="col">
          <div class="search-row">
            <h3>Î›Î¯ÏƒÏ„Î± Ï€ÎµÎ»Î±Ï„ÏÎ½</h3>
            <input id="c_search" class="search-box" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· (ÏŒÎ½Î¿Î¼Î±, Ï„Î·Î», Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·)...">
          </div>
          <div id="c_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.</div>
        </div>
      </div>
    </div>
  `;
}

function renderProjectsPage(){
  return `
    <div class="card">
      <h2>ÎˆÏÎ³Î±</h2>
      <div class="subtitle">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î­ÏÎ³Ï‰Î½ ÎµÎ³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ / ÏƒÏ…Î½Ï„Î®ÏÎ·ÏƒÎ·Ï‚ (Firestore).</div>
      <div class="row">
        <div class="col">
          <h3>ÎÎ­Î¿ / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï…</h3>
          <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
          <select id="p_customer"></select>
          <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î­ÏÎ³Î¿Ï…</label>
          <input id="p_title" placeholder="Ï€.Ï‡. Î•Î³ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· 2x12.000 BTU">
          <label>Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±</label>
          <input id="p_location" placeholder="Ï€.Ï‡. Î”Î¹Î±Î¼Î­ÏÎ¹ÏƒÎ¼Î± Î¤ÏƒÎ¹Î¼Î¹ÏƒÎºÎ® 12">
          <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
          <input id="p_date" type="date">
          <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
          <select id="p_status">
            <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ</option>
            <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
            <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î¿</option>
          </select>
          <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ / ÎµÎ¾Î¿Ï€Î»Î¹ÏƒÎ¼ÏŒÏ‚</label>
          <textarea id="p_notes" placeholder="ÎœÎ¿Î½Ï„Î­Î»Î± ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½, Ï…Î»Î¹ÎºÎ¬, Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚."></textarea>
          <div style="margin-top:8px;">
            <button class="btn small" id="p_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            <button class="btn secondary small" id="p_new">ÎÎ­Î¿</button>
          </div>
          <div id="p_msg" class="muted" style="margin-top:4px;"></div>
        </div>
        <div class="col">
          <div class="search-row">
            <div>
              <h3>Î›Î¯ÏƒÏ„Î± Î­ÏÎ³Ï‰Î½</h3>
              <span class="muted">Î¦Î¯Î»Ï„ÏÎ¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ & Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·.</span>
            </div>
          </div>
          <div class="row" style="margin-bottom:4px;">
            <div style="flex:1;min-width:120px;">
              <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
              <select id="p_filter">
                <option value="all">ÎŒÎ»Î±</option>
                <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î¬</option>
                <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
                <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î±</option>
              </select>
            </div>
            <div style="flex:2;min-width:160px;">
              <label>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</label>
              <input id="p_search" class="search-box" style="max-width:none;width:100%;" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Ï„Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±...">
            </div>
          </div>
          <div id="p_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.</div>
        </div>
      </div>
    </div>
  `;
}

function renderTasksPage(){
  return `
    <div class="card">
      <h2>Î•ÏÎ³Î±ÏƒÎ¯ÎµÏ‚</h2>
      <div class="subtitle">ÎšÎ±Î¸Î·Î¼ÎµÏÎ¹Î½Î­Ï‚ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚, Î²Î»Î¬Î²ÎµÏ‚, ÏƒÏ…Î½Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚ (Firestore).</div>
      <div class="row">
        <div class="col">
          <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</h3>
          <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
          <select id="t_customer"></select>
          <label>Î¤Î¯Ï„Î»Î¿Ï‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚</label>
          <input id="t_title" placeholder="Ï€.Ï‡. Service 24.000 BTU">
          <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</label>
          <input id="t_date" type="date">
          <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
          <select id="t_status">
            <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î®</option>
            <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
            <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</option>
          </select>
          <label>Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
          <textarea id="t_notes" placeholder="Î¤Î¹ Î­Î³Î¹Î½Îµ, Ï…Î»Î¹ÎºÎ¬, ÏÏÎµÏ‚ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ ÎºÏ„Î»."></textarea>
          <div style="margin-top:8px;">
            <button class="btn small" id="t_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            <button class="btn secondary small" id="t_new">ÎÎ­Î±</button>
          </div>
          <div id="t_msg" class="muted" style="margin-top:4px;"></div>
        </div>
        <div class="col">
          <div class="search-row">
            <div>
              <h3>Î›Î¯ÏƒÏ„Î± ÎµÏÎ³Î±ÏƒÎ¹ÏÎ½</h3>
              <span class="muted">Î¦Î¯Î»Ï„ÏÎ¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ & Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·.</span>
            </div>
          </div>
          <div class="row" style="margin-bottom:4px;">
            <div style="flex:1;min-width:120px;">
              <label>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</label>
              <select id="t_filter">
                <option value="all">ÎŒÎ»ÎµÏ‚</option>
                <option value="open">Î‘Î½Î¿Î¹Ï‡Ï„Î­Ï‚</option>
                <option value="inprogress">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</option>
                <option value="done">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</option>
              </select>
            </div>
            <div style="flex:2;min-width:160px;">
              <label>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</label>
              <input id="t_search" class="search-box" style="max-width:none;width:100%;" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚...">
            </div>
          </div>
          <div id="t_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.</div>
        </div>
      </div>
    </div>
  `;
}

function renderStudiesPage(){
  return `
    <div class="card">
      <h2>ÎœÎµÎ»Î­Ï„ÎµÏ‚ ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÎ¼Î¿Ï</h2>
      <div class="subtitle">ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Î¼ÎµÎ»ÎµÏ„ÏÎ½, ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Ï‰Î½ Î¼Îµ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ ÎºÎ±Î¹ Î­ÏÎ³Î± (Firestore).</div>
      <div class="row">
        <div class="col">
          <h3>ÎÎ­Î± / Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚</h3>
          <label>Î¤Î¯Ï„Î»Î¿Ï‚ Î¼ÎµÎ»Î­Ï„Î·Ï‚</label>
          <input id="s_title" placeholder="Ï€.Ï‡. ÎœÎµÎ»Î­Ï„Î· Î´Î¹Î±Î¼ÎµÏÎ¯ÏƒÎ¼Î±Ï„Î¿Ï‚ 85mÂ²">
          <label>Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
          <select id="s_customer"></select>
          <label>Î£Ï‡ÎµÏ„Î¹ÎºÏŒ Î­ÏÎ³Î¿ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)</label>
          <select id="s_project"></select>
          <label>Î ÎµÏÎ¯Î»Î·ÏˆÎ· / BTU / Î Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚</label>
          <textarea id="s_summary" placeholder="BTU Î±Î½Î¬ Ï‡ÏÏÎ¿, Î¼Î¿Î½Ï„Î­Î»Î± ÎºÎ»Î¹Î¼Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½, Î¸Î­ÏƒÎµÎ¹Ï‚ Î¼Î¿Î½Î¬Î´Ï‰Î½ ÎºÏ„Î»."></textarea>
          <div style="margin-top:8px;">
            <button class="btn small" id="s_save">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
            <button class="btn secondary small" id="s_new">ÎÎ­Î±</button>
          </div>
          <div id="s_msg" class="muted" style="margin-top:4px;"></div>
        </div>
        <div class="col">
          <div class="search-row">
            <div>
              <h3>Î‘ÏÏ‡ÎµÎ¯Î¿ Î¼ÎµÎ»ÎµÏ„ÏÎ½</h3>
              <span class="muted">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¼Îµ Ï„Î¯Ï„Î»Î¿, Ï€ÎµÎ»Î¬Ï„Î· Î® Î­ÏÎ³Î¿.</span>
            </div>
          </div>
          <input id="s_search" class="search-box" placeholder="Î¤Î¯Ï„Î»Î¿Ï‚, Ï€ÎµÎ»Î¬Ï„Î·Ï‚, Î­ÏÎ³Î¿...">
          <div id="s_list" class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÎµÎ»Î­Ï„ÎµÏ‚.</div>
        </div>
      </div>
      <div style="margin-top:8px;" class="muted">
        Î“Î¹Î± Î»ÎµÏ€Ï„Î¿Î¼ÎµÏÎ® ÏƒÏ‡ÎµÎ´Î¯Î±ÏƒÎ· & BTU Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î±Î½Î¿Î¯Î¾ÎµÎ¹Ï‚ Ï„Î¿Î½ Mouhtis AC Planner ÏƒÎµ Î½Î­Î¿ tab.
        <button class="btn secondary small" onclick="window.open('https://mouhtis.github.io/mouhtis-ac-planner/','_blank')">Î†Î½Î¿Î¹Î³Î¼Î± AC Planner</button>
      </div>
    </div>
  `;
}

/* ---------- SELECTS ---------- */
function populateCustomerSelects(){
  const customerSelectIds = ['p_customer','t_customer','s_customer'];
  customerSelectIds.forEach(id=>{
    const sel = $('#'+id);
    if(!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>';
    state.customers.forEach(c=>{
      const opt = document.createElement('option');
      opt.value=c.id;
      opt.textContent=c.name;
      sel.appendChild(opt);
    });
    if(prev) sel.value=prev;
  });

  const projectSelect = $('#s_project');
  if(projectSelect){
    const prev = projectSelect.value;
    projectSelect.innerHTML='<option value="">â€” Î§Ï‰ÏÎ¯Ï‚ Î­ÏÎ³Î¿ â€”</option>';
    state.projects.forEach(p=>{
      const opt = document.createElement('option');
      opt.value=p.id;
      opt.textContent=p.title;
      projectSelect.appendChild(opt);
    });
    if(prev) projectSelect.value=prev;
  }
}

/* ---------- CRUD: CUSTOMERS (FIRESTORE) ---------- */
async function saveCustomer(){
  const nameEl = $('#c_name');
  if(!nameEl) return;
  const name = nameEl.value.trim();
  if(!name){ $('#c_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ ÏŒÎ½Î¿Î¼Î±.'; return; }

  const data = {
    name,
    phone: $('#c_phone').value.trim(),
    email: $('#c_email').value.trim(),
    address: $('#c_address').value.trim(),
    notes: $('#c_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentCustomerId){
    const ref = await addDoc(collection(db,'customers'), data);
    state.currentCustomerId = ref.id;
    state.customers.unshift({id:ref.id, ...data, createdAt:new Date()});
  }else{
    const id = state.currentCustomerId;
    await setDoc(doc(db,'customers',id), data, {merge:true});
    const idx = state.customers.findIndex(c=>c.id===id);
    if(idx>=0) state.customers[idx] = {id, ...state.customers[idx], ...data};
  }
  $('#c_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderCustomerList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function clearCustomerForm(){
  state.currentCustomerId = null;
  const n = $('#c_name'); if(!n) return;
  n.value='';
  $('#c_phone').value='';
  $('#c_email').value='';
  $('#c_address').value='';
  $('#c_notes').value='';
  $('#c_msg').textContent='';
}

async function deleteCustomer(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Ï€ÎµÎ»Î¬Ï„Î·;'))return;
  await deleteDoc(doc(db,'customers',id));
  state.customers = state.customers.filter(c=>c.id!==id);
  state.projects.forEach(p=>{ if(p.customerId===id) p.customerId=''; });
  state.tasks.forEach(t=>{ if(t.customerId===id) t.customerId=''; });
  state.studies.forEach(s=>{ if(s.customerId===id) s.customerId=''; });
  clearCustomerForm();
  renderCustomerList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function renderCustomerList(){
  const wrap = $('#c_list');
  if(!wrap) return;
  const searchEl = $('#c_search');
  const q = (searchEl?.value || '').toLowerCase();
  let arr = state.customers.slice();
  if(q){
    arr = arr.filter(c=>
      (c.name||'').toLowerCase().includes(q) ||
      (c.phone||'').toLowerCase().includes(q) ||
      (c.address||'').toLowerCase().includes(q) ||
      (c.email||'').toLowerCase().includes(q)
    );
  }
  if(!arr.length){
    wrap.textContent = 'Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚.';
    return;
  }
  let html = '<table><thead><tr><th>ÎŒÎ½Î¿Î¼Î±</th><th>Î¤Î·Î»</th><th>Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(c=>{
    html += `<tr>
      <td>${c.name}</td>
      <td>${c.phone||''}</td>
      <td>${c.address||''}</td>
      <td>
        <span class="link" data-edit="${c.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${c.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;

  $$('#c_list [data-edit]').forEach(el=>{
    el.onclick = ()=>{
      const id = el.dataset.edit;
      const c = state.customers.find(x=>x.id===id);
      if(!c) return;
      state.currentCustomerId = c.id;
      $('#c_name').value=c.name;
      $('#c_phone').value=c.phone||'';
      $('#c_email').value=c.email||'';
      $('#c_address').value=c.address||'';
      $('#c_notes').value=c.notes||'';
      $('#c_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Ï€ÎµÎ»Î¬Ï„Î·.';
    };
  });
  $$('#c_list [data-del]').forEach(el=>{
    el.onclick = ()=> deleteCustomer(el.dataset.del);
  });
}

/* ---------- CRUD: PROJECTS ---------- */
async function saveProject(){
  const titleEl = $('#p_title');
  if(!titleEl) return;
  const title = titleEl.value.trim();
  if(!title){ $('#p_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î­ÏÎ³Î¿Ï….'; return; }

  const data = {
    customerId: $('#p_customer').value || '',
    title,
    location: $('#p_location').value.trim(),
    date: $('#p_date').value || '',
    status: $('#p_status').value,
    notes: $('#p_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentProjectId){
    const ref = await addDoc(collection(db,'projects'), data);
    state.currentProjectId = ref.id;
    state.projects.unshift({id:ref.id, ...data, createdAt:new Date()});
  }else{
    const id = state.currentProjectId;
    await setDoc(doc(db,'projects',id), data, {merge:true});
    const idx = state.projects.findIndex(p=>p.id===id);
    if(idx>=0) state.projects[idx] = {id, ...state.projects[idx], ...data};
  }
  $('#p_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderProjectList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function clearProjectForm(){
  state.currentProjectId=null;
  const t = $('#p_title'); if(!t) return;
  $('#p_customer').value='';
  t.value='';
  $('#p_location').value='';
  $('#p_date').value='';
  $('#p_status').value='open';
  $('#p_notes').value='';
  $('#p_msg').textContent='';
}

async function deleteProject(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Î­ÏÎ³Î¿Ï…;'))return;
  await deleteDoc(doc(db,'projects',id));
  state.projects = state.projects.filter(p=>p.id!==id);
  clearProjectForm();
  renderProjectList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function renderProjectList(){
  const wrap = $('#p_list');
  if(!wrap) return;
  const filter = $('#p_filter')?.value || 'all';
  const q = ($('#p_search')?.value || '').toLowerCase();
  let arr = state.projects.slice();
  if(filter!=='all') arr = arr.filter(p=>p.status===filter);
  if(q){
    arr = arr.filter(p=>{
      const client = state.customers.find(c=>c.id===p.customerId);
      return (p.title||'').toLowerCase().includes(q) ||
             (p.location||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­ÏÎ³Î±.';
    return;
  }
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(p=>{
    const client = state.customers.find(c=>c.id===p.customerId);
    const pill =
      p.status==='done' ? '<span class="pill green">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î¿</span>' :
      p.status==='inprogress' ? '<span class="pill orange">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</span>' :
      '<span class="pill red">Î‘Î½Î¿Î¹Ï‡Ï„ÏŒ</span>';
    html += `<tr>
      <td>${p.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${p.date||''}</td>
      <td>${pill}</td>
      <td>
        <span class="link" data-edit="${p.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${p.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#p_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const p = state.projects.find(x=>x.id===id);
      if(!p) return;
      state.currentProjectId=p.id;
      $('#p_customer').value=p.customerId||'';
      $('#p_title').value=p.title;
      $('#p_location').value=p.location||'';
      $('#p_date').value=p.date||'';
      $('#p_status').value=p.status;
      $('#p_notes').value=p.notes||'';
      $('#p_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î­ÏÎ³Î¿Ï….';
    };
  });
  $$('#p_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteProject(el.dataset.del);
  });
}

/* ---------- CRUD: TASKS ---------- */
async function saveTask(){
  const titleEl = $('#t_title');
  if(!titleEl) return;
  const title = titleEl.value.trim();
  if(!title){ $('#t_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.'; return; }

  const data = {
    customerId: $('#t_customer').value || '',
    title,
    date: $('#t_date').value || '',
    status: $('#t_status').value,
    notes: $('#t_notes').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentTaskId){
    const ref = await addDoc(collection(db,'tasks'), data);
    state.currentTaskId = ref.id;
    state.tasks.unshift({id:ref.id, ...data, createdAt:new Date()});
  }else{
    const id = state.currentTaskId;
    await setDoc(doc(db,'tasks',id), data, {merge:true});
    const idx = state.tasks.findIndex(t=>t.id===id);
    if(idx>=0) state.tasks[idx] = {id, ...state.tasks[idx], ...data};
  }
  $('#t_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderTaskList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function clearTaskForm(){
  state.currentTaskId=null;
  const t = $('#t_title'); if(!t) return;
  $('#t_customer').value='';
  t.value='';
  $('#t_date').value='';
  $('#t_status').value='open';
  $('#t_notes').value='';
  $('#t_msg').textContent='';
}

async function deleteTask(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚;'))return;
  await deleteDoc(doc(db,'tasks',id));
  state.tasks = state.tasks.filter(t=>t.id!==id);
  clearTaskForm();
  renderTaskList();
  renderDashboardSummary();
}

function renderTaskList(){
  const wrap = $('#t_list');
  if(!wrap) return;
  const filter = $('#t_filter')?.value || 'all';
  const q = ($('#t_search')?.value || '').toLowerCase();
  let arr = state.tasks.slice();
  if(filter!=='all') arr = arr.filter(t=>t.status===filter);
  if(q){
    arr = arr.filter(t=>{
      const client = state.customers.find(c=>c.id===t.customerId);
      return (t.title||'').toLowerCase().includes(q) ||
             (t.notes||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÏÎ³Î±ÏƒÎ¯ÎµÏ‚.';
    return;
  }
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>Î—Î¼/Î½Î¯Î±</th><th>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</th><th></th></tr></thead><tbody>';
  arr.forEach(t=>{
    const client = state.customers.find(c=>c.id===t.customerId);
    const pill =
      t.status==='done' ? '<span class="pill green">ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·</span>' :
      t.status==='inprogress' ? '<span class="pill orange">Î£Îµ ÎµÎ¾Î­Î»Î¹Î¾Î·</span>' :
      '<span class="pill red">Î‘Î½Î¿Î¹Ï‡Ï„Î®</span>';
    html += `<tr>
      <td>${t.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${t.date||''}</td>
      <td>${pill}</td>
      <td>
        <span class="link" data-edit="${t.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${t.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#t_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const t = state.tasks.find(x=>x.id===id);
      if(!t) return;
      state.currentTaskId=t.id;
      $('#t_customer').value=t.customerId||'';
      $('#t_title').value=t.title;
      $('#t_date').value=t.date||'';
      $('#t_status').value=t.status;
      $('#t_notes').value=t.notes||'';
      $('#t_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚.';
    };
  });
  $$('#t_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteTask(el.dataset.del);
  });
}

/* ---------- CRUD: STUDIES ---------- */
async function saveStudy(){
  const titleEl = $('#s_title');
  if(!titleEl) return;
  const title = titleEl.value.trim();
  if(!title){ $('#s_msg').textContent='Î£Ï…Î¼Ï€Î»Î®ÏÏ‰ÏƒÎµ Ï„Î¯Ï„Î»Î¿ Î¼ÎµÎ»Î­Ï„Î·Ï‚.'; return; }

  const data = {
    title,
    customerId: $('#s_customer').value || '',
    projectId: $('#s_project').value || '',
    summary: $('#s_summary').value.trim(),
    createdAt: serverTimestamp()
  };

  if(!state.currentStudyId){
    const ref = await addDoc(collection(db,'studies'), data);
    state.currentStudyId = ref.id;
    state.studies.unshift({id:ref.id, ...data, createdAt:new Date()});
  }else{
    const id = state.currentStudyId;
    await setDoc(doc(db,'studies',id), data, {merge:true});
    const idx = state.studies.findIndex(s=>s.id===id);
    if(idx>=0) state.studies[idx] = {id, ...state.studies[idx], ...data};
  }
  $('#s_msg').textContent='Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ.';
  renderStudyList();
  populateCustomerSelects();
  renderDashboardSummary();
}

function clearStudyForm(){
  state.currentStudyId=null;
  const t = $('#s_title'); if(!t) return;
  t.value='';
  $('#s_customer').value='';
  $('#s_project').value='';
  $('#s_summary').value='';
  $('#s_msg').textContent='';
}

async function deleteStudy(id){
  if(!confirm('Î”Î¹Î±Î³ÏÎ±Ï†Î® Î¼ÎµÎ»Î­Ï„Î·Ï‚;'))return;
  await deleteDoc(doc(db,'studies',id));
  state.studies = state.studies.filter(s=>s.id!==id);
  clearStudyForm();
  renderStudyList();
  renderDashboardSummary();
}

function renderStudyList(){
  const wrap = $('#s_list');
  if(!wrap) return;
  const q = ($('#s_search')?.value || '').toLowerCase();
  let arr = state.studies.slice();
  if(q){
    arr = arr.filter(s=>{
      const client = state.customers.find(c=>c.id===s.customerId);
      const proj = state.projects.find(p=>p.id===s.projectId);
      return (s.title||'').toLowerCase().includes(q) ||
             (s.summary||'').toLowerCase().includes(q) ||
             (client?.name||'').toLowerCase().includes(q) ||
             (proj?.title||'').toLowerCase().includes(q);
    });
  }
  if(!arr.length){
    wrap.textContent='Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î¼ÎµÎ»Î­Ï„ÎµÏ‚.';
    return;
  }
  let html='<table><thead><tr><th>Î¤Î¯Ï„Î»Î¿Ï‚</th><th>Î ÎµÎ»Î¬Ï„Î·Ï‚</th><th>ÎˆÏÎ³Î¿</th><th></th></tr></thead><tbody>';
  arr.forEach(s=>{
    const client = state.customers.find(c=>c.id===s.customerId);
    const proj = state.projects.find(p=>p.id===s.projectId);
    html += `<tr>
      <td>${s.title}</td>
      <td>${client?client.name:'â€”'}</td>
      <td>${proj?proj.title:'â€”'}</td>
      <td>
        <span class="link" data-edit="${s.id}">Î•Ï€ÎµÎ¾.</span> |
        <span class="link" data-del="${s.id}">Î”Î¹Î±Î³ÏÎ±Ï†Î®</span>
      </td>
    </tr>`;
  });
  html+='</tbody></table>';
  wrap.innerHTML=html;

  $$('#s_list [data-edit]').forEach(el=>{
    el.onclick=()=>{
      const id = el.dataset.edit;
      const s = state.studies.find(x=>x.id===id);
      if(!s) return;
      state.currentStudyId=s.id;
      $('#s_title').value=s.title;
      $('#s_customer').value=s.customerId||'';
      $('#s_project').value=s.projectId||'';
      $('#s_summary').value=s.summary||'';
      $('#s_msg').textContent='Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¼ÎµÎ»Î­Ï„Î·Ï‚.';
    };
  });
  $$('#s_list [data-del]').forEach(el=>{
    el.onclick=()=>deleteStudy(el.dataset.del);
  });
}

/* ---------- GLOBAL SEARCH ---------- */
function performGlobalSearch(){
  const input = $('#globalSearch');
  const results = $('#globalResults');
  if(!input || !results) return;
  const q = input.value.trim().toLowerCase();
  if(!q){
    results.textContent = 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î±ÎºÏŒÎ¼Î·.';
    return;
  }
  let matches = [];

  state.customers.forEach(c=>{
    const text = (c.name||'')+' '+(c.phone||'')+' '+(c.address||'')+' '+(c.notes||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'Î ÎµÎ»Î¬Ï„Î·Ï‚', label:c.name, extra:c.phone||c.address||'', id:c.id});
    }
  });
  state.projects.forEach(p=>{
    const client = state.customers.find(c=>c.id===p.customerId);
    const text = (p.title||'')+' '+(p.location||'')+' '+(p.notes||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'ÎˆÏÎ³Î¿', label:p.title, extra:client?client.name:'', id:p.id});
    }
  });
  state.tasks.forEach(t=>{
    const client = state.customers.find(c=>c.id===t.customerId);
    const text = (t.title||'')+' '+(t.notes||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'Î•ÏÎ³Î±ÏƒÎ¯Î±', label:t.title, extra:client?client.name:'', id:t.id});
    }
  });
  state.studies.forEach(s=>{
    const client = state.customers.find(c=>c.id===s.customerId);
    const text = (s.title||'')+' '+(s.summary||'')+' '+(client?.name||'');
    if(text.toLowerCase().includes(q)){
      matches.push({type:'ÎœÎµÎ»Î­Ï„Î·', label:s.title, extra:client?client.name:'', id:s.id});
    }
  });

  if(!matches.length){
    results.textContent = 'Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±.';
    return;
  }
  let html = '<ul class="muted" style="padding-left:18px;margin:4px 0;">';
  matches.slice(0,50).forEach(m=>{
    html += `<li><span class="tag">${m.type}</span> <strong>${m.label}</strong> ${m.extra?('â€” '+m.extra):''}</li>`;
  });
  html += '</ul>';
  results.innerHTML = html;
}

/* ---------- PAGE RENDER ---------- */
function renderPage(page){
  const container = $('#pageContainer');
  if(!container) return;
  let html='';
  if(page==='dashboard') html = renderDashboard();
  else if(page==='customers') html = renderCustomersPage();
  else if(page==='projects') html = renderProjectsPage();
  else if(page==='tasks') html = renderTasksPage();
  else if(page==='studies') html = renderStudiesPage();
  container.innerHTML = html;

  if(page==='dashboard'){
    renderDashboardSummary();
  }
  if(page==='customers'){
    populateCustomerSelects();
    renderCustomerList();
    const saveBtn = $('#c_save');
    const newBtn = $('#c_new');
    const sInput = $('#c_search');
    if(saveBtn) saveBtn.onclick = saveCustomer;
    if(newBtn) newBtn.onclick = clearCustomerForm;
    if(sInput) sInput.oninput = renderCustomerList;
  }
  if(page==='projects'){
    populateCustomerSelects();
    renderProjectList();
    const saveBtn = $('#p_save');
    const newBtn = $('#p_new');
    const fSel = $('#p_filter');
    const sInput = $('#p_search');
    if(saveBtn) saveBtn.onclick = saveProject;
    if(newBtn) newBtn.onclick = clearProjectForm;
    if(fSel) fSel.onchange = renderProjectList;
    if(sInput) sInput.oninput = renderProjectList;
  }
  if(page==='tasks'){
    populateCustomerSelects();
    renderTaskList();
    const saveBtn = $('#t_save');
    const newBtn = $('#t_new');
    const fSel = $('#t_filter');
    const sInput = $('#t_search');
    if(saveBtn) saveBtn.onclick = saveTask;
    if(newBtn) newBtn.onclick = clearTaskForm;
    if(fSel) fSel.onchange = renderTaskList;
    if(sInput) sInput.oninput = renderTaskList;
  }
  if(page==='studies'){
    populateCustomerSelects();
    renderStudyList();
    const saveBtn = $('#s_save');
    const newBtn = $('#s_new');
    const sInput = $('#s_search');
    if(saveBtn) saveBtn.onclick = saveStudy;
    if(newBtn) newBtn.onclick = clearStudyForm;
    if(sInput) sInput.oninput = renderStudyList;
  }
}

/* ---------- NAV ---------- */
function setActivePage(page){
  $$('.menu-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.page===page);
  });
  renderPage(page);
}

/* ---------- INIT ---------- */
async function init(){
  await loadStateFromFirestore();
  $$('.menu-btn').forEach(btn=>{
    btn.onclick = ()=> setActivePage(btn.dataset.page);
  });
  renderPage('dashboard');
  const gs = $('#globalSearch');
  if(gs) gs.addEventListener('input', performGlobalSearch);
}

init();
</script>

</body>
</html>
